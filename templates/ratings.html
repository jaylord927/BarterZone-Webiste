{% extends "base.html" %}
{% block content %}
<section class="hero-section">
  <div class="overlay" style="background: rgba(255,255,255,0.95); color:#333; max-width: 1400px; width:100%; padding:20px; border-radius:10px;">

    <h2 style="color:#0d47a1; margin-bottom:20px; text-align: center;">User Ratings & Reports</h2>

    <!-- User Rating Overview -->
    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid #0d47a1;">
      <h3 style="color:#0d47a1; margin-top:0; margin-bottom:20px; display: flex; align-items: center; gap: 10px;">
        <span>⭐</span>
        Your Rating Overview
      </h3>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <!-- Average Rating -->
        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <div style="font-size: 48px; color: #ff9800; margin-bottom: 10px;">⭐</div>
          <h4 style="color:#0d47a1; margin:0 0 10px 0;">Average Rating</h4>
          <div style="font-size: 32px; font-weight: bold; color: #0d47a1; margin-bottom: 5px;">
            {{ "%.1f"|format(user_rating.average_rating or 0) }}/5.0
          </div>
          <p style="color:#666; margin:0;">Based on {{ user_rating.total_ratings or 0 }} ratings</p>
        </div>

        <!-- Rating Breakdown -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <h4 style="color:#0d47a1; margin:0 0 15px 0;">Rating Breakdown</h4>
          <div style="display: grid; gap: 8px;">
            {% for stars in [5,4,3,2,1] %}
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="color: #ff9800; font-weight: bold;">{{ stars }}★</span>
              <div style="flex: 1; background: #f0f0f0; border-radius: 10px; height: 8px; overflow: hidden;">
                <div style="background: #ff9800; height: 100%; width: {{ (user_rating['%s_star'|format(stars)] or 0) / (user_rating.total_ratings or 1) * 100 }}%; border-radius: 10px;"></div>
              </div>
              <span style="font-size: 12px; color: #666; min-width: 30px;">{{ user_rating['%s_star'|format(stars)] or 0 }}</span>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Quick Actions -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <h4 style="color:#0d47a1; margin:0 0 15px 0;">Quick Actions</h4>
          <div style="display: grid; gap: 10px;">
            <a href="#rate-trades" class="btn-primary" style="padding: 10px; background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color: white; border: none; border-radius: 6px; text-decoration: none; text-align: center; font-weight: bold;">
              ⭐ Rate Completed Trades
            </a>
            <a href="#all-users" class="btn-primary" style="padding: 10px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border: none; border-radius: 6px; text-decoration: none; text-align: center; font-weight: bold;">
              👥 View All Users
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Rate Completed Trades -->
    <div id="rate-trades" style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid #4CAF50;">
      <h3 style="color:#2e7d32; margin-top:0; margin-bottom:20px; display: flex; align-items: center; gap: 10px;">
        <span>📝</span>
        Rate Completed Trades
      </h3>

      {% if rateable_trades %}
      <div style="display: grid; gap: 15px;">
        {% for trade in rateable_trades %}
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
            <div>
              <h4 style="color:#0d47a1; margin:0 0 5px 0;">Trade #{{ trade.trade_id }}</h4>
              <p style="color:#666; margin:0;">Rate your trading experience with <strong>{{ trade.user_to_rate_name }}</strong></p>
            </div>
            <div style="text-align: right;">
              <small style="color:#999;">Completed</small>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
              <strong style="color:#0d47a1;">Your Item:</strong>
              <p style="margin:5px 0 0 0; color:#333;">
                {% if trade.offer_user_id == user_id %}
                  {{ trade.offer_item_name }}
                {% else %}
                  {{ trade.target_item_name }}
                {% endif %}
              </p>
            </div>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
              <strong style="color:#0d47a1;">Their Item:</strong>
              <p style="margin:5px 0 0 0; color:#333;">
                {% if trade.offer_user_id == user_id %}
                  {{ trade.target_item_name }}
                {% else %}
                  {{ trade.offer_item_name }}
                {% endif %}
              </p>
            </div>
          </div>

          <form method="POST" action="{{ url_for('rate_user', trade_id=trade.trade_id, user_to_rate_id=trade.user_to_rate) }}" style="display: grid; gap: 10px;">
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: bold; color:#0d47a1;">Rating</label>
              <div style="display: flex; gap: 5px; justify-content: center;">
                {% for i in range(1, 6) %}
                <label style="cursor: pointer;">
                  <input type="radio" name="rating" value="{{ i }}" style="display: none;">
                  <span class="star-rating" data-rating="{{ i }}" style="font-size: 24px; color: #ddd; transition: color 0.2s;">★</span>
                </label>
                {% endfor %}
              </div>
            </div>

            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: bold; color:#0d47a1;">Comment (Optional)</label>
              <textarea name="comment" placeholder="Share your experience with this trader..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; min-height: 60px;"></textarea>
            </div>

            <button type="submit" class="btn-primary" style="padding: 10px; background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
              ⭐ Submit Rating
            </button>
          </form>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div style="text-align: center; padding: 40px; background: white; border-radius: 10px;">
        <div style="font-size: 48px; margin-bottom: 15px;">✅</div>
        <h4 style="color:#666; margin-bottom:10px;">All Caught Up!</h4>
        <p style="color:#999; margin:0;">You have no completed trades waiting for ratings.</p>
      </div>
      {% endif %}
    </div>

    <!-- All Users with Ratings -->
    <div id="all-users" style="background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 5px solid #ff9800;">
      <h3 style="color:#ef6c00; margin-top:0; margin-bottom:20px; display: flex; align-items: center; gap: 10px;">
        <span>👥</span>
        All Traders & Ratings
      </h3>

      {% if all_users %}
      <div style="overflow-x: auto;">
        <table style="width:100%; border-collapse:collapse; text-align:left; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color:white;">
              <th style="padding:15px; font-size:14px;">Trader</th>
              <th style="padding:15px; font-size:14px;">Location</th>
              <th style="padding:15px; font-size:14px;">Average Rating</th>
              <th style="padding:15px; font-size:14px;">Total Ratings</th>
              <th style="padding:15px; font-size:14px;">Completed Trades</th>
              <th style="padding:15px; font-size:14px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in all_users %}
            <tr style="border-bottom:1px solid #f0f0f0;">
              <td style="padding:15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    {{ (user.full_name or user.username)|first|upper }}
                  </div>
                  <div>
                    <strong style="color:#0d47a1;">{{ user.full_name or user.username }}</strong>
                    <div style="color:#666; font-size:12px;">@{{ user.username }}</div>
                  </div>
                </div>
              </td>
              <td style="padding:15px; color:#666;">
                {{ user.location or 'Not specified' }}
              </td>
              <td style="padding:15px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                  <span style="color: #ff9800; font-weight: bold;">{{ "%.1f"|format(user.average_rating or 0) }}</span>
                  <div style="color: #ff9800;">
                    {% for i in range(1, 6) %}
                      {% if i <= (user.average_rating or 0) %}
                        ★
                      {% else %}
                        ☆
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </td>
              <td style="padding:15px; color:#666;">
                {{ user.total_ratings }}
              </td>
              <td style="padding:15px; color:#666;">
                {{ user.total_trades }}
              </td>
              <td style="padding:15px;">
                <div style="display: flex; gap: 5px;">
                  <button onclick="viewUserRating({{ user.id }})" class="btn-primary" style="padding: 6px 12px; background: #546e7a; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                    View Details
                  </button>
                  <button onclick="openReportModal({{ user.id }})" class="btn-primary" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                    Report
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div style="text-align: center; padding: 40px; background: white; border-radius: 10px;">
        <div style="font-size: 48px; margin-bottom: 15px;">👥</div>
        <h4 style="color:#666; margin-bottom:10px;">No Other Traders</h4>
        <p style="color:#999; margin:0;">There are no other traders in the system yet.</p>
      </div>
      {% endif %}
    </div>

    <!-- Recent Ratings Received -->
    {% if recent_ratings %}
    <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 25px; border-radius: 12px; border-left: 5px solid #7b1fa2;">
      <h3 style="color:#7b1fa2; margin-top:0; margin-bottom:20px; display: flex; align-items: center; gap: 10px;">
        <span>💬</span>
        Recent Ratings You Received
      </h3>

      <div style="display: grid; gap: 15px;">
        {% for rating in recent_ratings %}
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
          <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                {{ (rating.full_name or rating.username)|first|upper }}
              </div>
              <div>
                <strong style="color:#0d47a1;">{{ rating.full_name or rating.username }}</strong>
                <div style="color: #ff9800; font-size: 14px;">
                  {% for i in range(1, 6) %}
                    {% if i <= rating.rating %}
                      ★
                    {% else %}
                      ☆
                    {% endif %}
                  {% endfor %}
                  <span style="color: #666; margin-left: 5px;">({{ rating.rating }}/5)</span>
                </div>
              </div>
            </div>
            <small style="color:#999;">{{ rating.created_at[:16] }}</small>
          </div>

          {% if rating.comment %}
          <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
            <p style="margin:0; color:#333; font-style: italic;">"{{ rating.comment }}"</p>
          </div>
          {% endif %}

          <div style="margin-top: 10px; font-size: 12px; color: #666;">
            Trade #{{ rating.trade_id }}: {{ rating.offer_item_name }} ↔ {{ rating.target_item_name }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>
</section>

<!-- Report Modal -->
<div id="reportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
    <h3 style="color:#0d47a1; margin-top:0; margin-bottom:20px;">Report User</h3>

    <form id="reportForm" method="POST" action="{{ url_for('report_user') }}">
      <input type="hidden" id="reported_user_id" name="reported_user_id">
      <input type="hidden" id="report_trade_id" name="trade_id">

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color:#0d47a1;">Reason for Report</label>
        <select name="reason" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
          <option value="">Select a reason</option>
          <option value="no_communication">No Communication</option>
          <option value="item_not_as_described">Item Not as Described</option>
          <option value="didnt_send_item">Didn't Send Item</option>
          <option value="rude_behavior">Rude Behavior</option>
          <option value="scam_attempt">Scam Attempt</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color:#0d47a1;">Description</label>
        <textarea name="description" placeholder="Please provide details about the issue..." required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; min-height: 100px;"></textarea>
      </div>

      <div style="display: flex; gap: 10px;">
        <button type="submit" class="btn-primary" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f44336 0%, #ef5350 100%); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
          📢 Submit Report
        </button>
        <button type="button" onclick="closeReportModal()" class="btn-primary" style="flex: 1; padding: 12px; background: #546e7a; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Star rating functionality
document.addEventListener('DOMContentLoaded', function() {
    // Star rating interaction
    document.querySelectorAll('.star-rating').forEach(star => {
        star.addEventListener('mouseenter', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            const stars = this.parentElement.parentElement.querySelectorAll('.star-rating');
            stars.forEach((s, index) => {
                s.style.color = index < rating ? '#ff9800' : '#ddd';
            });
        });

        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            const radio = this.parentElement.querySelector('input[type="radio"]');
            radio.checked = true;

            const stars = this.parentElement.parentElement.querySelectorAll('.star-rating');
            stars.forEach((s, index) => {
                s.style.color = index < rating ? '#ff9800' : '#ddd';
            });
        });
    });

    // Reset stars when leaving the group
    document.querySelectorAll('.star-rating').forEach(star => {
        star.parentElement.parentElement.addEventListener('mouseleave', function() {
            const checked = this.querySelector('input[type="radio"]:checked');
            const stars = this.querySelectorAll('.star-rating');

            if (checked) {
                const rating = parseInt(checked.value);
                stars.forEach((s, index) => {
                    s.style.color = index < rating ? '#ff9800' : '#ddd';
                });
            } else {
                stars.forEach(s => s.style.color = '#ddd');
            }
        });
    });
});

// Report modal functionality
function openReportModal(userId) {
    document.getElementById('reported_user_id').value = userId;
    document.getElementById('reportModal').style.display = 'flex';
}

function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
    document.getElementById('reportForm').reset();
}

// View user rating details
function viewUserRating(userId) {
    fetch(`/get_user_rating_stats/${userId}`)
        .then(response => response.json())
        .then(data => {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000;
                display: flex; justify-content: center; align-items: center;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="color:#0d47a1; margin-top:0; margin-bottom:20px;">User Rating Details</h3>

                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; color: #ff9800; margin-bottom: 10px;">⭐</div>
                        <div style="font-size: 32px; font-weight: bold; color: #0d47a1; margin-bottom: 5px;">
                            ${data.average_rating}/5.0
                        </div>
                        <p style="color:#666; margin:0;">Based on ${data.total_ratings} ratings</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color:#0d47a1; margin-bottom:15px;">Rating Breakdown</h4>
                        <div style="display: grid; gap: 8px;">
                            ${[5,4,3,2,1].map(stars => `
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: #ff9800; font-weight: bold;">${stars}★</span>
                                    <div style="flex: 1; background: #f0f0f0; border-radius: 10px; height: 8px; overflow: hidden;">
                                        <div style="background: #ff9800; height: 100%; width: ${(data.rating_breakdown[stars + '_star'] / (data.total_ratings || 1)) * 100}%; border-radius: 10px;"></div>
                                    </div>
                                    <span style="font-size: 12px; color: #666; min-width: 30px;">${data.rating_breakdown[stars + '_star']}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${data.recent_comments.length > 0 ? `
                    <div>
                        <h4 style="color:#0d47a1; margin-bottom:15px;">Recent Comments</h4>
                        <div style="display: grid; gap: 10px;">
                            ${data.recent_comments.map(comment => `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                    <div style="color: #ff9800; margin-bottom: 5px;">
                                        ${'★'.repeat(comment.rating)}${'☆'.repeat(5 - comment.rating)}
                                    </div>
                                    <p style="margin:0; color:#333; font-style: italic;">"${comment.comment}"</p>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                        - ${comment.full_name || comment.username}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <button onclick="this.parentElement.parentElement.remove()" class="btn-primary" style="width: 100%; padding: 12px; background: #546e7a; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px;">
                        Close
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading user rating details.');
        });
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    if (event.target.id === 'reportModal') {
        closeReportModal();
    }
});
</script>

<style>
.star-rating:hover {
    color: #ff9800 !important;
    transform: scale(1.2);
    transition: all 0.2s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Smooth scrolling for anchor links */
html {
    scroll-behavior: smooth;
}
</style>

{% endblock %}