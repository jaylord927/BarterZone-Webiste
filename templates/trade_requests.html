{% extends "base.html" %}
{% block content %}
<section class="hero-section">
  <div class="overlay" style="background: rgba(255,255,255,0.95); color:#333; max-width: 1200px; width:100%; padding:20px; border-radius:10px;">
    
    <h2 style="color:#0d47a1; margin-bottom:20px; text-align: center;">Trade Requests</h2>

    <!-- Debug Info (remove after testing) -->
    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0d47a1;">
      <h4 style="color:#0d47a1; margin:0 0 10px 0;">Debug Info</h4>
      <p style="margin:5px 0;"><strong>Logged in as:</strong> {{ session.username }} (User ID: {{ session.user_id }})</p>
      <p style="margin:5px 0;"><strong>Total trades:</strong> {{ trades|length }}</p>
    </div>

    {% if trades %}
    <div style="overflow-x: auto;">
      <table style="width:100%; border-collapse:collapse; text-align:left; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <thead>
          <tr style="background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color:white;">
            <th style="padding:15px; font-size:14px;">Type</th>
            <th style="padding:15px; font-size:14px;">From</th>
            <th style="padding:15px; font-size:14px;">Your Item</th>
            <th style="padding:15px; font-size:14px;">Their Item</th>
            <th style="padding:15px; font-size:14px;">Status</th>
            <th style="padding:15px; font-size:14px;">Date</th>
            <th style="padding:15px; font-size:14px;">Actions</th>
            <th style="padding:15px; font-size:14px;">Debug</th>
          </tr>
        </thead>
        <tbody>
          {% for trade in trades %}
          <tr style="border-bottom:1px solid #f0f0f0; transition: background-color 0.3s ease;">
            <td style="padding:15px;">
              <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
                {% if trade['request_type'] == 'Your Request' %}background-color: #e8f5e8; color: #2e7d32; border: 1px solid #2e7d32;
                {% else %}background-color: #e3f2fd; color: #0d47a1; border: 1px solid #0d47a1;{% endif %}">
                {{ trade['request_type'] }}
              </span>
            </td>
            <td style="padding:15px; font-weight:bold; color:#0d47a1;">
              {{ trade['offer_full_name'] or trade['offer_username'] }}
            </td>
            <td style="padding:15px;">
              <div style="font-weight: 500;">
                {% if trade['request_type'] == 'Your Request' %}
                    {{ trade['offer_item_name'] }}
                {% else %}
                    {{ trade['target_item_name'] }}
                {% endif %}
              </div>
              <small style="color: #666; font-size: 11px;">
                {% if trade['request_type'] == 'Your Request' %}
                    Your offered item
                {% else %}
                    Your item requested by {{ trade['offer_full_name'] or trade['offer_username'] }}
                {% endif %}
              </small>
              <br>
              <!-- View Details for Your Item -->
              {% if trade['request_type'] == 'Your Request' %}
                <a href="{{ url_for('view_item', item_id=trade['offer_item_id']) }}"
                   target="_blank"
                   style="margin-top: 5px; padding: 6px 12px; background: #546e7a; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; text-decoration: none; display: inline-block;">
                  View Your Item
                </a>
              {% else %}
                <a href="{{ url_for('view_item', item_id=trade['target_item_id']) }}"
                   target="_blank"
                   style="margin-top: 5px; padding: 6px 12px; background: #546e7a; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; text-decoration: none; display: inline-block;">
                  View Your Item
                </a>
              {% endif %}
            </td>
            <td style="padding:15px;">
              <div style="font-weight: 500;">
                {% if trade['request_type'] == 'Your Request' %}
                    {{ trade['target_item_name'] }}
                {% else %}
                    {{ trade['offer_item_name'] }}
                {% endif %}
              </div>
              <small style="color: #666; font-size: 11px;">
                {% if trade['request_type'] == 'Your Request' %}
                    Item you want from {{ trade['target_full_name'] or trade['target_username'] }}
                {% else %}
                    Item offered by {{ trade['offer_full_name'] or trade['offer_username'] }}
                {% endif %}
              </small>
              <br>
              <!-- View Details for Their Item -->
              {% if trade['request_type'] == 'Your Request' %}
                <a href="{{ url_for('view_item', item_id=trade['target_item_id']) }}"
                   target="_blank"
                   style="margin-top: 5px; padding: 6px 12px; background: #546e7a; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; text-decoration: none; display: inline-block;">
                  View Their Item
                </a>
              {% else %}
                <a href="{{ url_for('view_item', item_id=trade['offer_item_id']) }}"
                   target="_blank"
                   style="margin-top: 5px; padding: 6px 12px; background: #546e7a; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; text-decoration: none; display: inline-block;">
                  View Their Item
                </a>
              {% endif %}
            </td>
            <td style="padding:15px;">
              <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
                {% if trade['trade_status'] == 'pending' %}background-color: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00;
                {% elif trade['trade_status'] == 'accepted' %}background-color: #e8f5e8; color: #2e7d32; border: 1px solid #2e7d32;
                {% elif trade['trade_status'] == 'completed' %}background-color: #e3f2fd; color: #0d47a1; border: 1px solid #0d47a1;
                {% else %}background-color: #ffebee; color: #c62828; border: 1px solid #c62828;{% endif %}">
                {{ trade['trade_status']|title }}
              </span>
            </td>
            <td style="padding:15px; color: #666; font-size: 13px;">
              {{ trade['trade_date'] }}
            </td>
            <td style="padding:15px;">
              {% if trade['request_type'] == 'Incoming Request' and trade['trade_status'] == 'pending' %}
              <!-- Trader 2 (Receiver) can Accept/Decline incoming requests -->
              <form method="POST" action="{{ url_for('respond_trade', trade_id=trade['trade_id']) }}" style="display: flex; gap: 5px; flex-direction: column;">
                <button type="submit" name="action" value="accept"
                        style="padding: 8px 12px; background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                  Accept
                </button>
                <button type="submit" name="action" value="decline"
                        style="padding: 8px 12px; background: linear-gradient(135deg, #f44336 0%, #ef5350 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                  Decline
                </button>
              </form>

              {% elif trade['request_type'] == 'Your Request' and trade['trade_status'] == 'pending' %}
              <!-- Trader 1 (Sender) can Cancel their own pending requests -->
              <form method="POST" action="{{ url_for('respond_trade', trade_id=trade['trade_id']) }}" style="display: inline;">
                <button type="submit" name="action" value="cancel"
                        style="padding: 8px 12px; background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                  Cancel Request
                </button>
              </form>

              {% elif trade['trade_status'] == 'accepted' %}
              <!-- NEW: Unified Arrangement System Button -->
              <div style="display: flex; gap: 5px; flex-direction: column;">
                <a href="{{ url_for('trade_arrangement', trade_id=trade['trade_id']) }}"
                   class="btn btn-info btn-sm"
                   style="padding: 8px 12px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; text-align: center;">
                  ðŸ“‹ Arrange Exchange
                </a>

                <!-- Keep the old Manage Trade link as backup -->
                <a href="{{ url_for('trade_history') }}"
                   style="padding: 6px 10px; background: linear-gradient(135deg, #546e7a 0%, #78909c 100%); color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; text-align: center;">
                  Manage Trade (Old)
                </a>
              </div>

              {% else %}
              <span style="color: #999; font-size: 12px;">No actions available</span>
              {% endif %}
            </td>
            <td style="padding:15px; font-size: 11px; color: #666;">
              <div>Trade ID: {{ trade['trade_id'] }}</div>
              <div>Offer User: {{ trade['offer_user_id'] }}</div>
              <div>Target User: {{ trade['target_user_id'] }}</div>
              <div>You: {{ session.user_id }}</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <!-- Empty state -->
    <div style="text-align: center; padding: 40px; color: #666;">
      <h3 style="color: #999; margin-bottom: 10px;">No Trade Requests Yet</h3>
      <p>When you send or receive trade requests, they will appear here.</p>
      <a href="{{ url_for('other_traders_items') }}"
         style="display: inline-block; margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border: none; border-radius: 6px; text-decoration: none; font-weight: bold;">
        Browse Items to Trade
      </a>
    </div>
    {% endif %}
  </div>
</section>
{% endblock %}