{% extends "base.html" %}
{% block content %}
{% if session.user_id and session.is_admin %}
<!-- Admin content here -->

<section class="hero-section">
  <div class="overlay" style="background: rgba(255,255,255,0.95); color:#333; max-width: 1400px; width:100%; padding:20px; border-radius:10px;">

    <!-- Admin Header -->
    <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border-radius: 12px;">
      <h1 style="margin-bottom:10px; font-size: 32px;">🛡️ Admin Dashboard</h1>
      <p style="margin:0; font-size: 16px; opacity: 0.9;">Manage BarterZone Community & Platform</p>
    </div>

    <!-- Quick Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
      <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid #0d47a1;">
        <div style="font-size: 36px; color: #0d47a1;">👥</div>
        <h3 style="color:#0d47a1; margin:10px 0;">{{ total_users }}</h3>
        <p style="color:#666; margin:0;">Total Users</p>
      </div>
      <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid #f44336;">
        <div style="font-size: 36px; color: #f44336;">⚠️</div>
        <h3 style="color:#f44336; margin:10px 0;">{{ pending_reports }}</h3>
        <p style="color:#666; margin:0;">Pending Reports</p>
      </div>
      <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid #ff9800;">
        <div style="font-size: 36px; color: #ff9800;">💡</div>
        <h3 style="color:#ff9800; margin:10px 0;">{{ pending_suggestions }}</h3>
        <p style="color:#666; margin:0;">New Suggestions</p>
      </div>
      <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 4px solid #4CAF50;">
        <div style="font-size: 36px; color: #4CAF50;">🔒</div>
        <h3 style="color:#4CAF50; margin:10px 0;">{{ active_bans }}</h3>
        <p style="color:#666; margin:0;">Active Bans</p>
      </div>
    </div>

    <!-- Admin Navigation -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
      <button onclick="showSection('users')" class="admin-nav-btn active">
        👥 Manage Users
      </button>
      <button onclick="showSection('reports')" class="admin-nav-btn">
        ⚠️ User Reports
      </button>
      <button onclick="showSection('suggestions')" class="admin-nav-btn">
        💡 Suggestions
      </button>
      <button onclick="showSection('announcements')" class="admin-nav-btn">
        📢 Announcements
      </button>
      <button onclick="showSection('bans')" class="admin-nav-btn">
        🔒 Ban Management
      </button>
    </div>

    <!-- Users Management Section -->
    <div id="users-section" class="admin-section">
      <h2 style="color:#0d47a1; margin-bottom:20px;">👥 User Management</h2>

      <div style="margin-bottom: 20px;">
        <input type="text" id="userSearch" placeholder="🔍 Search users by name, username, or email..."
               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
      </div>

      <div style="overflow-x: auto;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Contact</th>
              <th>Location</th>
              <th>Joined</th>
              <th>Status</th>
              <th>Reports</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    {{ (user.full_name or user.username)|first|upper }}
                  </div>
                  <div>
                    <strong>{{ user.full_name or user.username }}</strong>
                    <br>
                    <small style="color: #666;">@{{ user.username }}</small>
                    {% if user.is_admin %}
                    <span style="background: #0d47a1; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">ADMIN</span>
                    {% endif %}
                  </div>
                </div>
              </td>
              <td>
                {{ user.email }}<br>
                <small style="color: #666;">{{ user.contact or 'No contact' }}</small>
              </td>
              <td>{{ user.location or 'Not specified' }}</td>
              <td>{{ user.join_date[:10] if user.join_date else 'N/A' }}</td>
              <td>
                {% if user.is_banned %}
                <span style="color: #f44336; font-weight: bold;">❌ Banned</span>
                {% else %}
                <span style="color: #4CAF50; font-weight: bold;">✅ Active</span>
                {% endif %}
              </td>
              <td>
                <span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                  {{ user.report_count or 0 }} reports
                </span>
              </td>
              <td>
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                  <button onclick="viewUserDetails({{ user.id }})" class="btn-action view">
                    👁️ View
                  </button>
                  {% if not user.is_admin %}
                    {% if user.is_banned %}
                    <button onclick="unbanUser({{ user.id }})" class="btn-action success">
                      🔓 Unban
                    </button>
                    {% else %}
                    <button onclick="showBanModal({{ user.id }}, '{{ user.username }}')" class="btn-action danger">
                      🔒 Ban
                    </button>
                    {% endif %}
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Reports Section -->
    <div id="reports-section" class="admin-section" style="display: none;">
      <h2 style="color:#0d47a1; margin-bottom:20px;">⚠️ User Reports</h2>

      <div style="overflow-x: auto;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Reported User</th>
              <th>Reported By</th>
              <th>Trade ID</th>
              <th>Reason</th>
              <th>Description</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for report in reports %}
            <tr>
              <td>
                <strong>{{ report.reported_username }}</strong>
                <br><small>{{ report.reported_email }}</small>
              </td>
              <td>
                {{ report.reporter_username }}
                <br><small>{{ report.reporter_email }}</small>
              </td>
              <td>#{{ report.trade_id }}</td>
              <td>
                <span style="background: #e3f2fd; color: #0d47a1; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                  {{ report.reason }}
                </span>
              </td>
              <td>
                <small>{{ report.description[:50] }}{% if report.description|length > 50 %}...{% endif %}</small>
              </td>
              <td>
                {% if report.status == 'pending' %}
                <span style="background: #fff3e0; color: #ef6c00; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                  Pending
                </span>
                {% elif report.status == 'resolved' %}
                <span style="background: #e8f5e8; color: #2e7d32; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                  Resolved
                </span>
                {% else %}
                <span style="background: #ffebee; color: #c62828; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                  {{ report.status|title }}
                </span>
                {% endif %}
              </td>
              <td>{{ report.created_at[:10] }}</td>
              <td>
                <div style="display: flex; gap: 5px;">
                  <button onclick="viewReportDetails({{ report.id }})" class="btn-action view">
                    👁️ View
                  </button>
                  {% if report.status == 'pending' %}
                  <button onclick="resolveReport({{ report.id }})" class="btn-action success">
                    ✅ Resolve
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Suggestions Section -->
    <div id="suggestions-section" class="admin-section" style="display: none;">
      <h2 style="color:#0d47a1; margin-bottom:20px;">💡 User Suggestions</h2>

      <div style="overflow-x: auto;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Type</th>
              <th>Priority</th>
              <th>Title</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for suggestion in suggestions %}
            <tr>
              <td>
                <strong>{{ suggestion.username }}</strong>
                <br><small>{{ suggestion.email }}</small>
              </td>
              <td>
                <span style="background: #e3f2fd; color: #0d47a1; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                  {{ suggestion.feedback_type|title }}
                </span>
              </td>
              <td>
                {% if suggestion.priority == 'critical' %}
                <span style="color: #c62828; font-weight: bold;">Critical</span>
                {% elif suggestion.priority == 'high' %}
                <span style="color: #ef6c00; font-weight: bold;">High</span>
                {% elif suggestion.priority == 'medium' %}
                <span style="color: #ff9800; font-weight: bold;">Medium</span>
                {% else %}
                <span style="color: #666; font-weight: bold;">Low</span>
                {% endif %}
              </td>
              <td>
                <strong>{{ suggestion.title }}</strong>
                <br><small style="color: #666;">{{ suggestion.description[:50] }}...</small>
              </td>
              <td>
                <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px;
                  {% if suggestion.status == 'completed' %}background: #e8f5e8; color: #2e7d32;
                  {% elif suggestion.status == 'in_progress' %}background: #fff3e0; color: #ef6c00;
                  {% else %}background: #f5f5f5; color: #666;{% endif %}">
                  {{ suggestion.status|title }}
                </span>
              </td>
              <td>{{ suggestion.created_at[:10] }}</td>
              <td>
                <div style="display: flex; gap: 5px;">
                  <button onclick="viewSuggestion({{ suggestion.id }})" class="btn-action view">
                    👁️ View
                  </button>
                  <button onclick="updateSuggestionStatus({{ suggestion.id }})" class="btn-action success">
                    📝 Update
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Announcements Section -->
    <div id="announcements-section" class="admin-section" style="display: none;">
      <h2 style="color:#0d47a1; margin-bottom:20px;">📢 Website Announcements</h2>

      <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <h3 style="color:#0d47a1; margin-top:0;">Create New Announcement</h3>
        <form method="POST" action="{{ url_for('create_announcement') }}">
          <div style="display: grid; gap: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold; color:#0d47a1;">Title</label>
              <input type="text" name="title" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold; color:#0d47a1;">Content</label>
              <textarea name="content" required style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical;"></textarea>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold; color:#0d47a1;">Priority</label>
              <select name="priority" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                <option value="normal">Normal</option>
                <option value="important">Important</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
            <button type="submit" class="btn-action success" style="width: 100%;">
              📢 Create Announcement
            </button>
          </div>
        </form>
      </div>

      <div style="overflow-x: auto;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Title</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for announcement in announcements %}
            <tr>
              <td>
                <strong>{{ announcement.title }}</strong>
                <br><small>{{ announcement.content[:50] }}...</small>
              </td>
              <td>
                {% if announcement.priority == 'urgent' %}
                <span style="color: #c62828; font-weight: bold;">Urgent</span>
                {% elif announcement.priority == 'important' %}
                <span style="color: #ef6c00; font-weight: bold;">Important</span>
                {% else %}
                <span style="color: #666; font-weight: bold;">Normal</span>
                {% endif %}
              </td>
              <td>
                {% if announcement.is_active %}
                <span style="color: #4CAF50; font-weight: bold;">✅ Active</span>
                {% else %}
                <span style="color: #666; font-weight: bold;">❌ Inactive</span>
                {% endif %}
              </td>
              <td>{{ announcement.created_at[:10] }}</td>
              <td>
                <div style="display: flex; gap: 5px;">
                  {% if announcement.is_active %}
                  <form method="POST" action="{{ url_for('toggle_announcement', announcement_id=announcement.id) }}" style="display: inline;">
                    <button type="submit" class="btn-action danger">
                      ❌ Deactivate
                    </button>
                  </form>
                  {% else %}
                  <form method="POST" action="{{ url_for('toggle_announcement', announcement_id=announcement.id) }}" style="display: inline;">
                    <button type="submit" class="btn-action success">
                      ✅ Activate
                    </button>
                  </form>
                  {% endif %}
                  <button onclick="deleteAnnouncement({{ announcement.id }})" class="btn-action danger">
                    🗑️ Delete
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Ban Management Section -->
    <div id="bans-section" class="admin-section" style="display: none;">
      <h2 style="color:#0d47a1; margin-bottom:20px;">🔒 Ban Management</h2>

      <div style="overflow-x: auto;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Banned By</th>
              <th>Reason</th>
              <th>Duration</th>
              <th>Banned Until</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for ban in bans %}
            <tr>
              <td>
                <strong>{{ ban.username }}</strong>
                <br><small>{{ ban.email }}</small>
              </td>
              <td>{{ ban.admin_username }}</td>
              <td>{{ ban.reason }}</td>
              <td>
                {% if ban.is_permanent %}
                <span style="color: #c62828; font-weight: bold;">Permanent</span>
                {% else %}
                {{ ban.duration_days }} days
                {% endif %}
              </td>
              <td>
                {% if ban.is_permanent %}
                <span style="color: #c62828; font-weight: bold;">Forever</span>
                {% else %}
                {{ ban.banned_until[:10] if ban.banned_until else 'N/A' }}
                {% endif %}
              </td>
              <td>
                {% if ban.is_active %}
                <span style="color: #f44336; font-weight: bold;">🔒 Active</span>
                {% else %}
                <span style="color: #4CAF50; font-weight: bold;">✅ Expired</span>
                {% endif %}
              </td>
              <td>
                {% if ban.is_active %}
                <button onclick="unbanUser({{ ban.user_id }})" class="btn-action success">
                  🔓 Unban
                </button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</section>

<!-- Ban User Modal -->
<div id="banModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
    <h3 style="color:#0d47a1; margin-top:0;">🔒 Ban User</h3>
    <p id="banUserInfo" style="margin-bottom: 20px;"></p>

    <form id="banForm" method="POST" action="{{ url_for('ban_user') }}">
      <input type="hidden" id="banUserId" name="user_id">

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color:#0d47a1;">Ban Reason</label>
        <textarea name="reason" required placeholder="Enter detailed reason for banning this user..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color:#0d47a1;">Ban Duration</label>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="radio" name="duration" value="7" required>
            <span>7 days</span>
          </label>
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="radio" name="duration" value="30">
            <span>30 days</span>
          </label>
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="radio" name="duration" value="90">
            <span>90 days</span>
          </label>
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="radio" name="duration" value="permanent">
            <span>Permanent</span>
          </label>
        </div>
      </div>

      <div style="display: flex; gap: 10px;">
        <button type="submit" class="btn-action danger" style="flex: 1;">
          🔒 Confirm Ban
        </button>
        <button type="button" onclick="closeBanModal()" class="btn-action" style="flex: 1; background: #546e7a;">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<style>
.admin-nav-btn {
  padding: 15px;
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.admin-nav-btn:hover, .admin-nav-btn.active {
  background: #0d47a1;
  color: white;
  border-color: #0d47a1;
  transform: translateY(-2px);
}

.admin-section {
  background: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
  text-align: left;
}

.admin-table th {
  background: #f8f9fa;
  padding: 15px;
  font-weight: bold;
  color: #0d47a1;
  border-bottom: 2px solid #e0e0e0;
}

.admin-table td {
  padding: 15px;
  border-bottom: 1px solid #f0f0f0;
}

.admin-table tr:hover {
  background: #f8f9fa;
}

.btn-action {
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-action.view { background: #546e7a; color: white; }
.btn-action.success { background: #4CAF50; color: white; }
.btn-action.danger { background: #f44336; color: white; }

.btn-action:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
</style>

<script>
// Section Navigation
function showSection(sectionName) {
  // Hide all sections
  document.querySelectorAll('.admin-section').forEach(section => {
    section.style.display = 'none';
  });

  // Remove active class from all buttons
  document.querySelectorAll('.admin-nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });

  // Show selected section and activate button
  document.getElementById(sectionName + '-section').style.display = 'block';
  event.target.classList.add('active');
}

// Ban User Modal
function showBanModal(userId, username) {
  document.getElementById('banUserId').value = userId;
  document.getElementById('banUserInfo').textContent = `You are about to ban user: ${username}`;
  document.getElementById('banModal').style.display = 'flex';
}

function closeBanModal() {
  document.getElementById('banModal').style.display = 'none';
  document.getElementById('banForm').reset();
}

// User Search
document.getElementById('userSearch').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('#users-section tbody tr');

  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
});

// Placeholder functions for other actions
function viewUserDetails(userId) {
  alert('View user details: ' + userId);
  // Implement user details view
}

function viewReportDetails(reportId) {
  alert('View report details: ' + reportId);
  // Implement report details view
}

function viewSuggestion(suggestionId) {
  alert('View suggestion: ' + suggestionId);
  // Implement suggestion details view
}

function resolveReport(reportId) {
  if (confirm('Mark this report as resolved?')) {
    // Implement report resolution
    alert('Report resolved: ' + reportId);
  }
}

function updateSuggestionStatus(suggestionId) {
  alert('Update suggestion status: ' + suggestionId);
  // Implement status update
}

function unbanUser(userId) {
  if (confirm('Are you sure you want to unban this user?')) {
    // Implement unban functionality
    alert('User unbanned: ' + userId);
  }
}

function deleteAnnouncement(announcementId) {
  if (confirm('Are you sure you want to delete this announcement?')) {
    // Implement delete functionality
    alert('Announcement deleted: ' + announcementId);
  }
}

// Close modal when clicking outside
document.getElementById('banModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeBanModal();
  }
});
</script>

{% else %}
<!-- Access Denied for non-admin users -->
<div style="text-align: center; padding: 50px;">
    <h2 style="color:#0d47a1;">Access Denied</h2>
    <p>Admin dashboard is only accessible to administrators.</p>
    <a href="{{ url_for('dashboard') }}" class="btn-primary">Go to Dashboard</a>
</div>
{% endif %}
{% endblock %}