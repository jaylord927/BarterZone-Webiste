{% extends "base.html" %}

{% block content %}
<section class="hero-section">
  <div class="overlay" style="background: rgba(255,255,255,0.95); color:#333; max-width: 1200px; width:100%; padding:20px; border-radius:10px;">

    <!-- Header -->
    <div style="text-align: center; margin-bottom: 30px;">
      <h2 style="color:#0d47a1; margin-bottom:10px;">Trade Arrangement Details</h2>
      <p style="color:#666; margin:0;">Trade ID: {{ trade.trade_id }} â€¢ Trading with:
        {% if trade.offer_user_id == user_id %}
          {{ trade.target_full_name or trade.target_username }}
        {% else %}
          {{ trade.offer_full_name or trade.offer_username }}
        {% endif %}
      </p>
    </div>

    <!-- Progress Guide - ENHANCED VERSION -->
    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 10px; margin-bottom: 25px;">
      <h4 style="color:#0d47a1; margin-top:0; text-align: center;">Trade Arrangement Progress</h4>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">

        <!-- Step 1: Setup Details -->
        <div style="background: {% if arrangement and arrangement.method %}white{% else %}#e8f5e8{% endif %}; padding: 15px; border-radius: 8px; border: 2px solid {% if arrangement and arrangement.method %}#0d47a1{% else %}#4CAF50{% endif %};">
          <div style="width: 40px; height: 40px; background: {% if arrangement and arrangement.method %}#0d47a1{% else %}#4CAF50{% endif %}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">
            {% if arrangement and arrangement.method %}âœ“{% else %}1{% endif %}
          </div>
          <h5 style="color:#0d47a1; margin:0 0 8px 0;">Setup Details</h5>
          <p style="margin:0; font-size:13px; color:#666;">
            {% if arrangement and arrangement.method %}
              âœ… Details submitted
            {% else %}
              Choose method and arrange exchange details
            {% endif %}
          </p>
        </div>

        <!-- Step 2: Confirm Exchange -->
        <div style="background: {% if arrangement and arrangement.user1_confirmed_details and arrangement.user2_confirmed_details %}white{% else %}{% if arrangement and arrangement.method %}#e8f5e8{% else %}#f5f5f5{% endif %}{% endif %}; padding: 15px; border-radius: 8px; border: 2px solid {% if arrangement and arrangement.user1_confirmed_details and arrangement.user2_confirmed_details %}#0d47a1{% else %}{% if arrangement and arrangement.method %}#4CAF50{% else %}#ddd{% endif %}{% endif %};">
          <div style="width: 40px; height: 40px; background: {% if arrangement and arrangement.user1_confirmed_details and arrangement.user2_confirmed_details %}#0d47a1{% else %}{% if arrangement and arrangement.method %}#4CAF50{% else %}#ddd{% endif %}{% endif %}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">
            {% if arrangement and arrangement.user1_confirmed_details and arrangement.user2_confirmed_details %}âœ“{% else %}2{% endif %}
          </div>
          <h5 style="color:#0d47a1; margin:0 0 8px 0;">Confirm Exchange</h5>
          <p style="margin:0; font-size:13px; color:#666;">
            {% if arrangement and arrangement.user1_confirmed_details and arrangement.user2_confirmed_details %}
              âœ… Both users confirmed
            {% elif arrangement and arrangement.method %}
              Both users confirm arrangement details
            {% else %}
              Waiting for setup details
            {% endif %}
          </p>
        </div>

        <!-- Step 3: Complete Trade -->
        <div style="background: {% if arrangement and arrangement.status == 'completed' %}white{% else %}{% if arrangement and arrangement.user1_confirmed_details and arrangement.user2_confirmed_details %}#e8f5e8{% else %}#f5f5f5{% endif %}{% endif %}; padding: 15px; border-radius: 8px; border: 2px solid {% if arrangement and arrangement.status == 'completed' %}#0d47a1{% else %}{% if arrangement and arrangement.user1_confirmed_details and arrangement.user2_confirmed_details %}#4CAF50{% else %}#ddd{% endif %}{% endif %};">
          <div style="width: 40px; height: 40px; background: {% if arrangement and arrangement.status == 'completed' %}#0d47a1{% else %}{% if arrangement and arrangement.user1_confirmed_details and arrangement.user2_confirmed_details %}#4CAF50{% else %}#ddd{% endif %}{% endif %}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">
            {% if arrangement and arrangement.status == 'completed' %}âœ“{% else %}3{% endif %}
          </div>
          <h5 style="color:#0d47a1; margin:0 0 8px 0;">Complete Trade</h5>
          <p style="margin:0; font-size:13px; color:#666;">
            {% if arrangement and arrangement.status == 'completed' %}
              âœ… Trade Completed!
            {% elif arrangement and arrangement.user1_confirmed_details and arrangement.user2_confirmed_details %}
              Exchange items and confirm receipt
            {% else %}
              Waiting for confirmation
            {% endif %}
          </p>
        </div>
      </div>
    </div>

    <!-- Current Arrangement Status Display -->
    {% if arrangement %}
    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 25px;">

      {% if arrangement.status == 'completed' %}
      <!-- COMPLETED TRADE VERSION -->
      <div style="text-align: center; margin-bottom: 25px;">
        <div style="font-size: 64px; margin-bottom: 15px;">ğŸ‰</div>
        <h3 style="color:#2e7d32; margin:0 0 10px 0;">Trade Successfully Completed!</h3>
        <p style="color:#4CAF50; font-size: 16px; margin:0;">Both items have been exchanged and received</p>
      </div>
      {% endif %}

      <h4 style="color:#0d47a1; margin-top:0; margin-bottom:20px; display: flex; align-items: center; gap: 8px;">
        <span>ğŸ“‹</span>
        {% if arrangement.status == 'completed' %}
          Trade Completion Summary
        {% else %}
          Exchange Arrangement Details
        {% endif %}
      </h4>

      <!-- Exchange Method Summary -->
      <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h5 style="color:#0d47a1; margin:0 0 10px 0; display: flex; align-items: center; gap: 8px;">
          <span>ğŸ”„</span> Exchange Method:
          <span style="text-transform: capitalize; background: white; padding: 4px 12px; border-radius: 15px; margin-left: 10px;">
            {{ arrangement.method }}
          </span>
          {% if arrangement.status == 'completed' %}
          <span style="margin-left: auto; background: #4CAF50; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px;">
            âœ… COMPLETED
          </span>
          {% endif %}
        </h5>
      </div>

      <!-- Exchange Details Grid -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">

        <!-- Meetup Exchange Details -->
        {% if arrangement.method in ['meetup', 'mixed'] and arrangement.meetup_location %}
        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; border-left: 4px solid #4caf50;">
          <h5 style="color:#2e7d32; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ¤</span> Meetup Exchange
          </h5>

          <div style="display: grid; gap: 12px;">
            <div>
              <strong style="color:#0d47a1;">ğŸ“ Meetup Location:</strong>
              <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                {{ arrangement.meetup_location or 'Not specified' }}
              </p>
            </div>

            {% if arrangement.meetup_date %}
            <div>
              <strong style="color:#0d47a1;">ğŸ“… Meetup Date:</strong>
              <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                {{ arrangement.meetup_date }}
              </p>
            </div>
            {% endif %}

            {% if arrangement.meetup_time %}
            <div>
              <strong style="color:#0d47a1;">â° Meetup Time:</strong>
              <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                {{ arrangement.meetup_time }}
              </p>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Delivery Exchange Details - SEPARATED BY USER -->
{% if arrangement.method in ['delivery', 'mixed'] %}
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; grid-column: 1 / -1;">

  <!-- User 1's Delivery Details (Jaylord) -->
  <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 4px solid #0d47a1;">
    <h5 style="color:#0d47a1; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
      <span>ğŸ“¦</span> {{ trade.offer_full_name or trade.offer_username }}'s Delivery Details
      {% if trade.offer_user_id == user_id %}
      <span style="margin-left: auto; background: #0d47a1; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
          (You)
      </span>
      {% endif %}
    </h5>

    <div style="display: grid; gap: 12px;">
      <!-- My Delivery Address -->
      <div>
        <strong style="color:#0d47a1;">ğŸ  My Delivery Address:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.offer_delivery_address or 'Not specified yet' }}
        </p>
        <small style="color:#666;">My location where I want to receive items</small>
      </div>

      <!-- Your Delivery Address -->
      <div>
        <strong style="color:#0d47a1;">ğŸ  Your Delivery Address:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.target_delivery_address or 'Not specified yet' }}
        </p>
        <small style="color:#666;">Where I will send my items to you</small>
      </div>

      <!-- Courier Service -->
      <div>
        <strong style="color:#0d47a1;">ğŸš› My Courier Service:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.offer_courier_option|upper if arrangement.offer_courier_option else 'Not specified yet' }}
        </p>
        <small style="color:#666;">Courier service I will use for shipping</small>
      </div>

      <!-- Delivery Date -->
      <div>
        <strong style="color:#0d47a1;">ğŸ“… Expected Delivery Date:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.offer_delivery_date or 'Not specified yet' }}
        </p>
        <small style="color:#666;">When your item should arrive at my address</small>
      </div>

      <!-- Tracking Number -->
      <div>
        <strong style="color:#0d47a1;">ğŸ”¢ My Tracking Number:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.offer_tracking_number or 'Not specified yet' }}
        </p>
        <small style="color:#666;">Track the package I'm sending to you</small>
      </div>

      <!-- Delivery Instructions -->
      {% if arrangement.offer_delivery_instructions %}
      <div>
        <strong style="color:#0d47a1;">ğŸ“ Special Instructions:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.offer_delivery_instructions }}
        </p>
        <small style="color:#666;">Additional delivery instructions</small>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- User 2's Delivery Details (Keth) -->
  <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; border-left: 4px solid #4caf50;">
    <h5 style="color:#2e7d32; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
      <span>ğŸ“¦</span> {{ trade.target_full_name or trade.target_username }}'s Delivery Details
      {% if trade.target_user_id == user_id %}
      <span style="margin-left: auto; background: #4caf50; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
          (You)
      </span>
      {% endif %}
    </h5>

    <div style="display: grid; gap: 12px;">
      <!-- My Delivery Address -->
      <div>
        <strong style="color:#0d47a1;">ğŸ  My Delivery Address:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.target_delivery_address or 'Not specified yet' }}
        </p>
        <small style="color:#666;">My location where I want to receive items</small>
      </div>

      <!-- Your Delivery Address -->
      <div>
        <strong style="color:#0d47a1;">ğŸ  Your Delivery Address:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.offer_delivery_address or 'Not specified yet' }}
        </p>
        <small style="color:#666;">Where I will send my items to you</small>
      </div>

      <!-- Courier Service -->
      <div>
        <strong style="color:#0d47a1;">ğŸš› My Courier Service:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.target_courier_option|upper if arrangement.target_courier_option else 'Not specified yet' }}
        </p>
        <small style="color:#666;">Courier service I will use for shipping</small>
      </div>

      <!-- Delivery Date -->
      <div>
        <strong style="color:#0d47a1;">ğŸ“… Expected Delivery Date:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.target_delivery_date or 'Not specified yet' }}
        </p>
        <small style="color:#666;">When your item should arrive at my address</small>
      </div>

      <!-- Tracking Number -->
      <div>
        <strong style="color:#0d47a1;">ğŸ”¢ My Tracking Number:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.target_tracking_number or 'Not specified yet' }}
        </p>
        <small style="color:#666;">Track the package I'm sending to you</small>
      </div>

      <!-- Delivery Instructions -->
      {% if arrangement.target_delivery_instructions %}
      <div>
        <strong style="color:#0d47a1;">ğŸ“ Special Instructions:</strong>
        <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
          {{ arrangement.target_delivery_instructions }}
        </p>
        <small style="color:#666;">Additional delivery instructions</small>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

        <!-- Mixed Method Additional Details -->
        {% if arrangement.method == 'mixed' %}
        <div style="background: #fff3e0; padding: 20px; border-radius: 10px; border-left: 4px solid #ff9800; grid-column: 1 / -1;">
          <h5 style="color:#ef6c00; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ”€</span> Mixed Method Exchange Plan
          </h5>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Who's Delivering -->
            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ff9800;">
              <h6 style="color:#ef6c00; margin:0 0 10px 0; display: flex; align-items: center; gap: 5px;">
                <span>ğŸšš</span> Delivering Item
              </h6>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">
                  {{ (trade.offer_full_name or trade.offer_username)|first|upper }}
                </div>
                <div>
                  <strong style="color:#0d47a1;">{{ trade.offer_full_name or trade.offer_username }}</strong>
                  <p style="margin: 2px 0 0 0; color:#666; font-size: 12px;">Sending: {{ trade.offer_item_name }}</p>
                </div>
              </div>
            </div>

            <!-- Who's Meeting -->
            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #4caf50;">
              <h6 style="color:#2e7d32; margin:0 0 10px 0; display: flex; align-items: center; gap: 5px;">
                <span>ğŸ¤</span> Meeting Up
              </h6>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 30px; height: 30px; background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">
                  {{ (trade.target_full_name or trade.target_username)|first|upper }}
                </div>
                <div>
                  <strong style="color:#2e7d32;">{{ trade.target_full_name or trade.target_username }}</strong>
                  <p style="margin: 2px 0 0 0; color:#666; font-size: 12px;">Bringing: {{ trade.target_item_name }}</p>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 6px;">
            <strong style="color:#0d47a1;">ğŸ“‹ Exchange Process:</strong>
            <p style="margin: 5px 0 0 0; color:#0d47a1; font-size: 13px;">
              {{ trade.offer_full_name or trade.offer_username }} will deliver their item, while
              {{ trade.target_full_name or trade.target_username }} will meet up for the exchange.
              Both users must confirm receipt of their respective items.
            </p>
          </div>
        </div>
        {% endif %}

        <!-- Trade Completion Info -->
        {% if arrangement.status == 'completed' %}
        <div style="background: #fff3e0; padding: 20px; border-radius: 10px; border-left: 4px solid #ff9800; grid-column: 1 / -1;">
          <h5 style="color:#ef6c00; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
            <span>âœ…</span> Trade Completion
          </h5>

          <div style="display: grid; gap: 12px;">
            <div>
              <strong style="color:#0d47a1;">ğŸ”„ Items Exchanged:</strong>
              <div style="margin: 5px 0 0 0; color:#333; background: white; padding: 10px; border-radius: 6px;">
                <strong>{{ trade.offer_full_name or trade.offer_username }}</strong> received:<br>
                <span style="color: #4CAF50;">{{ trade.target_item_name }}</span>
              </div>
              <div style="margin: 8px 0 0 0; color:#333; background: white; padding: 10px; border-radius: 6px;">
                <strong>{{ trade.target_full_name or trade.target_username }}</strong> received:<br>
                <span style="color: #4CAF50;">{{ trade.offer_item_name }}</span>
              </div>
            </div>

            <div>
              <strong style="color:#0d47a1;">ğŸ“Š Completion Details:</strong>
              <div style="margin: 5px 0 0 0; color:#333; background: white; padding: 10px; border-radius: 6px;">
                <strong>Status:</strong> <span style="color: #4CAF50; font-weight: bold;">COMPLETED</span><br>
                <strong>Completed on:</strong> {{ arrangement.updated_at[:16] if arrangement.updated_at else 'Today' }}<br>
                {% if arrangement.tracking_number %}
                <strong>Tracking #:</strong> {{ arrangement.tracking_number }}<br>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Users Status Section -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- User 1 Status -->
        <div class="user-status-card {% if arrangement.user1_confirmed_details and arrangement.user1_confirmed_receipt %}confirmed{% endif %}">
          <h5 style="color:#0d47a1; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ‘¤</span> {{ trade.offer_full_name or trade.offer_username }}'s Status
          </h5>

          <div class="confirmation-status">
            <span class="confirmation-badge {% if arrangement.user1_confirmed_details %}confirmed-badge{% else %}pending-badge{% endif %}">
              {% if arrangement.user1_confirmed_details %}âœ… Confirmed{% else %}â³ Pending{% endif %}
            </span>
            <strong>Details Confirmed</strong>
          </div>

          {% if arrangement.method in ['meetup', 'mixed'] and arrangement.meetup_location %}
          <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
            <small style="color:#666; display: block; margin-bottom: 5px;"><strong>Exchange Action:</strong></small>
            <small style="color:#333;">ğŸ“ <strong>Meetup at:</strong> {{ arrangement.meetup_location }}</small>
          </div>
          {% endif %}

          <div class="confirmation-status">
            <span class="confirmation-badge {% if arrangement.user1_confirmed_receipt %}confirmed-badge{% else %}pending-badge{% endif %}">
              {% if arrangement.user1_confirmed_receipt %}âœ… Received{% else %}â³ Waiting{% endif %}
            </span>
            <strong>Item Received</strong>
          </div>
        </div>

        <!-- User 2 Status -->
        <div class="user-status-card {% if arrangement.user2_confirmed_details and arrangement.user2_confirmed_receipt %}confirmed{% endif %}">
          <h5 style="color:#0d47a1; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ‘¤</span> {{ trade.target_full_name or trade.target_username }}'s Status
          </h5>

          <div class="confirmation-status">
            <span class="confirmation-badge {% if arrangement.user2_confirmed_details %}confirmed-badge{% else %}pending-badge{% endif %}">
              {% if arrangement.user2_confirmed_details %}âœ… Confirmed{% else %}â³ Pending{% endif %}
            </span>
            <strong>Details Confirmed</strong>
          </div>

          {% if arrangement.method in ['delivery', 'mixed'] and arrangement.delivery_address %}
          <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
            <small style="color:#666; display: block; margin-bottom: 5px;"><strong>Exchange Action:</strong></small>
            <small style="color:#333;">ğŸ“¦ <strong>Deliver to:</strong> {{ arrangement.delivery_address }}</small>
          </div>
          {% endif %}

          <div class="confirmation-status">
            <span class="confirmation-badge {% if arrangement.user2_confirmed_receipt %}confirmed-badge{% else %}pending-badge{% endif %}">
              {% if arrangement.user2_confirmed_receipt %}âœ… Received{% else %}â³ Waiting{% endif %}
            </span>
            <strong>Item Received</strong>
          </div>
        </div>
      </div>

      <!-- Completion Celebration -->
      {% if arrangement.status == 'completed' %}
      <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border-radius: 12px; border: 2px solid #4CAF50; text-align: center;">
        <h4 style="color:#2e7d32; margin:0 0 10px 0;">ğŸŠ Trade Successfully Completed! ğŸŠ</h4>
        <p style="color:#2e7d32; margin:0; font-size: 14px;">
          Thank you for using BarterZone! Both traders have successfully exchanged their items.
        </p>

        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
          <a href="{{ url_for('trade_history') }}"
             style="padding: 10px 20px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; text-decoration: none;">
            ğŸ“Š View Trade History
          </a>
          <a href="{{ url_for('other_traders_items') }}"
             style="padding: 10px 20px; background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; text-decoration: none;">
            ğŸ”„ Start New Trade
          </a>
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
      <!-- Left Column: Arrangement Form -->
      <div>
        <!-- Method Selection - Only show if no arrangement or status is pending -->
        {% if not arrangement or (arrangement and arrangement.status == 'pending') %}
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
          <h4 style="color:#0d47a1; margin-top:0; margin-bottom:15px;">
            {% if arrangement %}Update Exchange Method{% else %}Select Exchange Method{% endif %}
          </h4>
          <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
            <div class="method-option {% if arrangement and arrangement.method == 'meetup' %}active{% endif %}"
                 onclick="selectMethod('meetup')"
                 style="border: 2px solid {% if arrangement and arrangement.method == 'meetup' %}#0d47a1{% else %}#e0e0e0{% endif %}; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: {% if arrangement and arrangement.method == 'meetup' %}#e3f2fd{% else %}white{% endif %};">
              <h5 style="color:#0d47a1; margin:0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                <span>ğŸ¤</span> Meetup Exchange
              </h5>
              <p style="margin:0 0 10px 0; color:#666; font-size:14px;">Meet in person to exchange items</p>
              <ul style="margin:0; padding-left: 20px; color:#666; font-size:13px;">
                <li>Agree on location, date, and time</li>
                <li>Both users must be present</li>
                <li>Instant item exchange</li>
              </ul>
            </div>

            <div class="method-option {% if arrangement and arrangement.method == 'delivery' %}active{% endif %}"
                 onclick="selectMethod('delivery')"
                 style="border: 2px solid {% if arrangement and arrangement.method == 'delivery' %}#0d47a1{% else %}#e0e0e0{% endif %}; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: {% if arrangement and arrangement.method == 'delivery' %}#e3f2fd{% else %}white{% endif %};">
              <h5 style="color:#0d47a1; margin:0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                <span>ğŸšš</span> Delivery Exchange
              </h5>
              <p style="margin:0 0 10px 0; color:#666; font-size:14px;">Send items via courier/delivery service</p>
              <ul style="margin:0; padding-left: 20px; color:#666; font-size:13px;">
                <li>Provide delivery address</li>
                <li>Set shipping date</li>
                <li>Track package progress</li>
              </ul>
            </div>

            <div class="method-option {% if arrangement and arrangement.method == 'mixed' %}active{% endif %}"
                 onclick="selectMethod('mixed')"
                 style="border: 2px solid {% if arrangement and arrangement.method == 'mixed' %}#0d47a1{% else %}#e0e0e0{% endif %}; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: {% if arrangement and arrangement.method == 'mixed' %}#e3f2fd{% else %}white{% endif %};">
              <h5 style="color:#0d47a1; margin:0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                <span>ğŸ”€</span> Mixed Method
              </h5>
              <p style="margin:0 0 10px 0; color:#666; font-size:14px;">One delivers, one meets up</p>
              <ul style="margin:0; padding-left: 20px; color:#666; font-size:13px;">
                <li>Flexible arrangement</li>
                <li>Different methods for each user</li>
                <li>Customized exchange</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Dynamic Form Sections -->
        <form id="arrangementForm" method="POST" action="{{ url_for('trade_arrangement', trade_id=trade.trade_id) }}" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <input type="hidden" name="method" id="method" value="{{ arrangement.method if arrangement }}">

          <!-- Meetup Section -->
          <div id="meetupSection" class="method-section" style="display: {% if arrangement and arrangement.method in ['meetup', 'mixed'] %}block{% else %}none{% endif %}; margin-bottom: 20px;">
            <h5 style="color:#0d47a1; margin-top:0; margin-bottom:15px; display: flex; align-items: center; gap: 8px;">
              <span>ğŸ“</span> Meetup Details
            </h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">Location</label>
                <input type="text" name="meetup_location" placeholder="Enter meetup location"
                       value="{{ arrangement.meetup_location if arrangement }}"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">Time</label>
                <input type="time" name="meetup_time" value="{{ arrangement.meetup_time if arrangement }}"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
              </div>
            </div>
            <div style="margin-top: 12px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">Date</label>
              <input type="date" name="meetup_date" value="{{ arrangement.meetup_date if arrangement }}"
                     style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
            </div>
          </div>

          <!-- Delivery Section - DUAL DISPLAY WITH PROPER EDITING -->
          <div id="deliverySection" class="method-section" style="display: {% if arrangement and arrangement.method in ['delivery', 'mixed'] %}block{% else %}none{% endif %}; margin-bottom: 20px;">
            <h5 style="color:#0d47a1; margin-top:0; margin-bottom:15px; display: flex; align-items: center; gap: 8px;">
              <span>ğŸ“¦</span> Delivery Details
            </h5>

            <!-- ========== DISPLAY BOTH USERS' INFORMATION ========== -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">

              <!-- User 1's Delivery Details -->
              <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 4px solid #0d47a1;">
                <h5 style="color:#0d47a1; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                  <span>ğŸ“¦</span> {{ trade.offer_full_name or trade.offer_username }}'s Delivery Details
                  {% if trade.offer_user_id == user_id %}
                  <span style="margin-left: auto; background: #0d47a1; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                      (You)
                  </span>
                  {% endif %}
                </h5>

                <div style="display: grid; gap: 12px;">
                  <div>
                    <strong style="color:#0d47a1;">ğŸ  My Delivery Address:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                      {{ arrangement.offer_delivery_address or 'Not specified yet' }}
                    </p>
                    <small style="color:#666;">My location where I want to receive items</small>
                  </div>

                  <div>
                    <strong style="color:#0d47a1;">ğŸ  Your Delivery Address:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                      {{ arrangement.target_delivery_address or 'Not specified yet' }}
                    </p>
                    <small style="color:#666;">Where I will send my items to you</small>
                  </div>

                  {% if arrangement.offer_courier_option %}
                  <div>
                    <strong style="color:#0d47a1;">ğŸš› My Courier Service:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                      {{ arrangement.offer_courier_option|upper }}
                    </p>
                    <small style="color:#666;">Courier service I will use for shipping</small>
                  </div>
                  {% endif %}

                  {% if arrangement.offer_delivery_date %}
                  <div>
                    <strong style="color:#0d47a1;">ğŸ“… Expected Delivery Date:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                      {{ arrangement.offer_delivery_date }}
                    </p>
                    <small style="color:#666;">When your item should arrive at my address</small>
                  </div>
                  {% endif %}

                  {% if arrangement.offer_tracking_number %}
                  <div>
                    <strong style="color:#0d47a1;">ğŸ”¢ My Tracking Number:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                      {{ arrangement.offer_tracking_number }}
                    </p>
                    <small style="color:#666;">Track the package I'm sending to you</small>
                  </div>
                  {% endif %}
                </div>
              </div>

              <!-- User 2's Delivery Details -->
              <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; border-left: 4px solid #4caf50;">
                <h5 style="color:#2e7d32; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                  <span>ğŸ“¦</span> {{ trade.target_full_name or trade.target_username }}'s Delivery Details
                  {% if trade.target_user_id == user_id %}
                  <span style="margin-left: auto; background: #4caf50; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                      (You)
                  </span>
                  {% endif %}
                </h5>

                <div style="display: grid; gap: 12px;">
                  <div>
                    <strong style="color:#0d47a1;">ğŸ  My Delivery Address:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                      {{ arrangement.target_delivery_address or 'Not specified yet' }}
                    </p>
                    <small style="color:#666;">My location where I want to receive items</small>
                  </div>

                  <div>
                    <strong style="color:#0d47a1;">ğŸ  Your Delivery Address:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                      {{ arrangement.offer_delivery_address or 'Not specified yet' }}
                    </p>
                    <small style="color:#666;">Where I will send my items to you</small>
                  </div>

                  {% if arrangement.target_courier_option %}
                  <div>
                    <strong style="color:#0d47a1;">ğŸš› My Courier Service:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                      {{ arrangement.target_courier_option|upper }}
                    </p>
                    <small style="color:#666;">Courier service I will use for shipping</small>
                  </div>
                  {% endif %}

                  {% if arrangement.target_delivery_date %}
                  <div>
                    <strong style="color:#0d47a1;">ğŸ“… Expected Delivery Date:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                      {{ arrangement.target_delivery_date }}
                    </p>
                    <small style="color:#666;">When your item should arrive at my address</small>
                  </div>
                  {% endif %}

                  {% if arrangement.target_tracking_number %}
                  <div>
                    <strong style="color:#0d47a1;">ğŸ”¢ My Tracking Number:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                      {{ arrangement.target_tracking_number }}
                    </p>
                    <small style="color:#666;">Track the package I'm sending to you</small>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- ========== EDITING SECTION - USER CAN ONLY EDIT THEIR OWN ========== -->
<div style="background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #ff9800; margin-bottom: 20px;">
  <h5 style="color:#ef6c00; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
    <span>âœï¸</span>
    {% if trade.offer_user_id == user_id %}
      Edit Your Delivery Details ({{ trade.offer_full_name or trade.offer_username }})
    {% else %}
      Edit Your Delivery Details ({{ trade.target_full_name or trade.target_username }})
    {% endif %}
  </h5>

  <form method="POST" action="{{ url_for('trade_arrangement', trade_id=trade.trade_id )}}">
    <input type="hidden" name="method" id="method" value="{{ arrangement.method if arrangement }}">

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
      <!-- My Delivery Address -->
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">
          ğŸ  My Delivery Address
          <small style="color:#666;">(Where you want to receive items)</small>
        </label>
        {% if trade.offer_user_id == user_id %}
        <textarea name="offer_delivery_address" placeholder="Enter your complete delivery address"
                  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px; min-height: 80px; resize: vertical;">{{ arrangement.offer_delivery_address if arrangement }}</textarea>
        {% else %}
        <textarea name="target_delivery_address" placeholder="Enter your complete delivery address"
                  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px; min-height: 80px; resize: vertical;">{{ arrangement.target_delivery_address if arrangement }}</textarea>
        {% endif %}
      </div>

      <!-- My Courier Service -->
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">
          ğŸš› My Courier Service
          <small style="color:#666;">(Service you will use for shipping)</small>
        </label>
        {% if trade.offer_user_id == user_id %}
        <select name="offer_courier_option" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
          <option value="">Select courier</option>
          <option value="lbc" {% if arrangement and arrangement.offer_courier_option == 'lbc' %}selected{% endif %}>LBC</option>
          <option value="jnt" {% if arrangement and arrangement.offer_courier_option == 'jnt' %}selected{% endif %}>J&T Express</option>
          <option value="grab" {% if arrangement and arrangement.offer_courier_option == 'grab' %}selected{% endif %}>Grab Delivery</option>
          <option value="lalamove" {% if arrangement and arrangement.offer_courier_option == 'lalamove' %}selected{% endif %}>Lalamove</option>
          <option value="other" {% if arrangement and arrangement.offer_courier_option == 'other' %}selected{% endif %}>Other</option>
        </select>
        {% else %}
        <select name="target_courier_option" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
          <option value="">Select courier</option>
          <option value="lbc" {% if arrangement and arrangement.target_courier_option == 'lbc' %}selected{% endif %}>LBC</option>
          <option value="jnt" {% if arrangement and arrangement.target_courier_option == 'jnt' %}selected{% endif %}>J&T Express</option>
          <option value="grab" {% if arrangement and arrangement.target_courier_option == 'grab' %}selected{% endif %}>Grab Delivery</option>
          <option value="lalamove" {% if arrangement and arrangement.target_courier_option == 'lalamove' %}selected{% endif %}>Lalamove</option>
          <option value="other" {% if arrangement and arrangement.target_courier_option == 'other' %}selected{% endif %}>Other</option>
        </select>
        {% endif %}
      </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
      <!-- Expected Delivery Date -->
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">
          ğŸ“… Expected Delivery Date
          <small style="color:#666;">(When you expect to ship/receive)</small>
        </label>
        {% if trade.offer_user_id == user_id %}
        <input type="date" name="offer_delivery_date" value="{{ arrangement.offer_delivery_date if arrangement }}"
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
        {% else %}
        <input type="date" name="target_delivery_date" value="{{ arrangement.target_delivery_date if arrangement }}"
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
        {% endif %}
      </div>

      <!-- My Tracking Number -->
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">
          ğŸ”¢ My Tracking Number
          <small style="color:#666;">(Once you have shipped your item)</small>
        </label>
        {% if trade.offer_user_id == user_id %}
        <input type="text" name="offer_tracking_number" placeholder="Enter tracking number"
               value="{{ arrangement.offer_tracking_number if arrangement }}"
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
        {% else %}
        <input type="text" name="target_tracking_number" placeholder="Enter tracking number"
               value="{{ arrangement.target_tracking_number if arrangement }}"
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
        {% endif %}
      </div>
    </div>

    <!-- Special Instructions -->
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">
        ğŸ“ Special Instructions
        <small style="color:#666;">(Any special delivery instructions)</small>
      </label>
      {% if trade.offer_user_id == user_id %}
      <textarea name="offer_delivery_instructions" placeholder="Any special delivery instructions"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px; min-height: 60px; resize: vertical;">{{ arrangement.offer_delivery_instructions if arrangement }}</textarea>
      {% else %}
      <textarea name="target_delivery_instructions" placeholder="Any special delivery instructions"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px; min-height: 60px; resize: vertical;">{{ arrangement.target_delivery_instructions if arrangement }}</textarea>
      {% endif %}
    </div>

    <button type="submit"
            style="width: 100%; padding: 12px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
      ğŸ’¾ Update My Delivery Details
    </button>
  </form>
</div>

            <!-- Information Note -->
            <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 3px solid #0d47a1;">
              <strong style="color:#0d47a1;">ğŸ’¡ How this works:</strong>
              <p style="margin: 5px 0 0 0; color:#0d47a1; font-size: 13px;">
                â€¢ <strong>Both users see all information</strong> - You can see each other's details<br>
                â€¢ <strong>You can only edit your own section</strong> - Use the form below to update your personal delivery details<br>
                â€¢ <strong>All changes are visible to both users</strong> - Keep each other informed
              </p>
            </div>
          </div>

          <button type="submit"
                  style="width: 100%; padding: 12px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
            ğŸ’¾ {% if arrangement %}Update{% else %}Save{% endif %} Arrangement Details
          </button>
        </form>
        {% endif %}
      </div>

      <!-- Right Column: Status & Actions -->
      <div>
        <!-- Status Card -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
          <h4 style="color:#0d47a1; margin-top:0; margin-bottom:15px; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ“Š</span> Trade Status
          </h4>

          <div style="text-align: center; margin-bottom: 20px;">
            <div style="display: inline-block; padding: 8px 20px; background:
              {% if arrangement and arrangement.status == 'completed' %}#e8f5e8
              {% elif arrangement and arrangement.status == 'accepted' %}#e3f2fd
              {% elif arrangement and arrangement.status == 'pending' %}#fff3e0
              {% else %}#f5f5f5{% endif %};
              color: {% if arrangement and arrangement.status == 'completed' %}#2e7d32
              {% elif arrangement and arrangement.status == 'accepted' %}#0d47a1
              {% elif arrangement and arrangement.status == 'pending' %}#ef6c00
              {% else %}#666{% endif %};
              border-radius: 20px; font-weight: bold; border: 2px solid currentColor;">
              {{ arrangement.status|title if arrangement else 'Not Started' }}
            </div>
          </div>

          <!-- User Status Grid -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
            <!-- User 1 -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
              <div style="font-size: 12px; color:#666; margin-bottom: 5px;">{{ trade.offer_full_name or trade.offer_username }}</div>
              <div style="font-size: 20px; margin-bottom: 5px;">{{ 'âœ…' if arrangement and arrangement.user1_confirmed_details else 'âŒ' }}</div>
              <small style="color:#666;">Details Confirmed</small>
              <div style="font-size: 20px; margin-top: 5px;">{{ 'âœ…' if arrangement and arrangement.user1_confirmed_receipt else 'âŒ' }}</div>
              <small style="color:#666;">Item Received</small>
            </div>

            <!-- User 2 -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
              <div style="font-size: 12px; color:#666; margin-bottom: 5px;">{{ trade.target_full_name or trade.target_username }}</div>
              <div style="font-size: 20px; margin-bottom: 5px;">{{ 'âœ…' if arrangement and arrangement.user2_confirmed_details else 'âŒ' }}</div>
              <small style="color:#666;">Details Confirmed</small>
              <div style="font-size: 20px; margin-top: 5px;">{{ 'âœ…' if arrangement and arrangement.user2_confirmed_receipt else 'âŒ' }}</div>
              <small style="color:#666;">Item Received</small>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
          <h4 style="color:#0d47a1; margin-top:0; margin-bottom:15px; display: flex; align-items: center; gap: 8px;">
            <span>âš¡</span> Quick Actions
          </h4>

          <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
            {% if arrangement and arrangement.status == 'pending' %}
              {% if not (arrangement.user1_confirmed_details and arrangement.user2_confirmed_details) %}
                {% if (trade.offer_user_id == user_id and not arrangement.user1_confirmed_details) or (trade.target_user_id == user_id and not arrangement.user2_confirmed_details) %}
                <button onclick="confirmDetails()"
                        style="padding: 12px; background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                  âœ… Confirm All Details
                </button>
                {% endif %}
              {% endif %}
            {% endif %}

            {% if arrangement and arrangement.status == 'accepted' %}
              {% if (trade.offer_user_id == user_id and not arrangement.user1_confirmed_receipt) or (trade.target_user_id == user_id and not arrangement.user2_confirmed_receipt) %}
              <button onclick="markReceived()"
                      style="padding: 12px; background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                ğŸ“¦ Mark Item as Received
              </button>
              {% endif %}
            {% endif %}

            <button onclick="openLocationPicker()"
                    style="padding: 12px; background: linear-gradient(135deg, #546e7a 0%, #78909c 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">
              ğŸ“ Use My Location
            </button>

            <button onclick="printArrangement()"
                    style="padding: 12px; background: linear-gradient(135deg, #795548 0%, #8d6e63 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">
              ğŸ–¨ï¸ Print Details
            </button>

            {% if arrangement and arrangement.status != 'completed' %}
            <button onclick="cancelTrade()"
                    style="padding: 12px; background: linear-gradient(135deg, #f44336 0%, #ef5350 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
              âŒ Cancel Trade
            </button>
            {% endif %}
          </div>
        </div>

        <!-- Negotiation Chat -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <h4 style="color:#0d47a1; margin-top:0; margin-bottom:15px; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ’¬</span> Negotiation & Suggestions
          </h4>

          <div class="chat-messages" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
            {% for message in messages %}
              <div class="message {% if message.user_id == user_id %}own-message{% endif %}"
                   style="background: {% if message.user_id == user_id %}#e3f2fd{% else %}white{% endif %}; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid {% if message.user_id == user_id %}#0d47a1{% else %}#4CAF50{% endif %};">
                <div style="font-weight: bold; color:#0d47a1; margin-bottom: 5px;">{{ message.username }}</div>
                <div style="color:#333; margin-bottom: 5px;">{{ message.content }}</div>
                {% if message.suggested_location %}
                  <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin: 5px 0; font-size: 13px;">
                    ğŸ“ Location Suggestion: {{ message.suggested_location }}
                    <button onclick="useSuggestion('{{ message.suggested_location }}')"
                            style="margin-left: 10px; padding: 2px 8px; background: #0d47a1; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                      Use This
                    </button>
                  </div>
                {% endif %}
                <div style="font-size: 11px; color:#666;">{{ message.created_at }}</div>
              </div>
            {% endfor %}
          </div>

          <div class="chat-input" style="display: flex; gap: 8px;">
            <input type="text" id="chatMessage" placeholder="Send a message or suggestion..."
                   style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
            <button onclick="sendMessage()"
                    style="padding: 10px 15px; background: #0d47a1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size:14px;">
              Send
            </button>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 10px;">
            <button onclick="suggestLocation()"
                    style="flex: 1; padding: 8px 12px; background: #546e7a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size:13px;">
              ğŸ“ Suggest Location
            </button>
            <button onclick="suggestDate()"
                    style="flex: 1; padding: 8px 12px; background: #546e7a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size:13px;">
              ğŸ“… Suggest Date
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
// Enhanced confirmation with validation
function confirmDetails() {
    if (confirm('Are you sure you want to confirm these arrangement details? Once both users confirm, the trade will be accepted.')) {
        // Show loading state
        showNotification('Confirming details...', 'info');

        fetch(`/trade/{{ trade.trade_id }}/confirm_details`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showNotification(data.message, 'success');
                // Reload the page after a short delay to show updated status
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification(data.message || 'Failed to confirm details.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error confirming details. Please try again.', 'error');
        });
    }
}

// Enhanced mark received with tracking
function markReceived() {
    const trackingNumber = prompt('Optional: Enter tracking number if available:\n\nğŸ“¦ Leave blank if not applicable.', '');

    if (trackingNumber === null) {
        console.log('User cancelled the operation');
        return; // User clicked cancel
    }

    if (confirm('Have you received the item from the other trader?')) {
        console.log('User confirmed receipt');

        // Show loading state
        showNotification('Marking item as received...', 'info');

        const data = {};
        if (trackingNumber && trackingNumber.trim() !== '') {
            data.tracking_number = trackingNumber.trim();
            console.log('Tracking number provided:', data.tracking_number);
        } else {
            console.log('No tracking number provided');
        }

        fetch(`/trade/{{ trade.trade_id }}/confirm_receipt`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.status === 'completed') {
                showNotification(data.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } else if (data.status === 'waiting') {
                showNotification(data.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification(data.message || 'Failed to mark item as received.', 'error');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showNotification('Network error. Please check console for details.', 'error');
        });
    } else {
        console.log('User cancelled receipt confirmation');
    }
}

function suggestLocation() {
    const location = prompt('Enter your suggested location:');
    if (location && location.trim()) {
        fetch(`/trade/{{ trade.trade_id }}/suggest_location`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({location: location.trim()})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showNotification('Location suggestion sent!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('Failed to send location suggestion.', 'error');
            }
        })
        .catch(error => {
            showNotification('Network error. Please try again.', 'error');
        });
    }
}

function useSuggestion(location) {
    if (confirm(`Use this suggested location: "${location}"?`)) {
        document.querySelector('input[name="meetup_location"]').value = location;
        document.getElementById('method').value = 'meetup';
        selectMethod('meetup');
        showNotification('Location applied to meetup details!', 'success');
    }
}

// Enhanced trade cancellation
function cancelTrade() {
    const reason = prompt('Please provide a reason for cancellation (optional):');
    const confirmation = confirm('Are you sure you want to cancel this trade? This action cannot be undone.');

    if (confirmation) {
        fetch(`/trade/{{ trade.trade_id }}/cancel`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({reason: reason})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showNotification('Trade cancelled successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '/trade_history';
                }, 2000);
            } else {
                showNotification('Failed to cancel trade. Please try again.', 'error');
            }
        })
        .catch(error => {
            showNotification('Network error. Please try again.', 'error');
        });
    }
}

// Enhanced method selection with auto-save
function selectMethod(method) {
    document.getElementById('method').value = method;

    // Update method option styles
    document.querySelectorAll('.method-option').forEach(option => {
        option.style.borderColor = '#e0e0e0';
        option.style.background = 'white';
    });

    const selectedOption = document.querySelector(`.method-option[onclick="selectMethod('${method}')"]`);
    if (selectedOption) {
        selectedOption.style.borderColor = '#0d47a1';
        selectedOption.style.background = '#e3f2fd';
    }

    // Show/hide sections
    document.querySelectorAll('.method-section').forEach(section => {
        section.style.display = 'none';
    });

    if (method === 'meetup') {
        document.getElementById('meetupSection').style.display = 'block';
    } else if (method === 'delivery') {
        document.getElementById('deliverySection').style.display = 'block';
    } else if (method === 'mixed') {
        document.getElementById('meetupSection').style.display = 'block';
        document.getElementById('deliverySection').style.display = 'block';
    }
}

// Location picker integration
function openLocationPicker() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const location = `${lat}, ${lng}`;

                if (confirm(`Use your current location? ${location}`)) {
                    document.querySelector('input[name="meetup_location"]').value = `GPS: ${location}`;
                    document.getElementById('method').value = 'meetup';
                    selectMethod('meetup');
                }
            },
            (error) => {
                alert('Unable to get your location. Please enter it manually.');
            }
        );
    } else {
        alert('Geolocation is not supported by your browser.');
    }
}

// Print arrangement details
function printArrangement() {
    const printContent = `
        <h2>Trade Arrangement Details</h2>
        <p><strong>Trade ID:</strong> {{ trade.trade_id }}</p>
        <p><strong>Parties:</strong> {{ trade.offer_full_name or trade.offer_username }} â†” {{ trade.target_full_name or trade.target_username }}</p>
        <p><strong>Status:</strong> {{ arrangement.status if arrangement else 'Not Started' }}</p>
        <p><strong>Method:</strong> {{ arrangement.method if arrangement else 'Not Set' }}</p>
        {% if arrangement and arrangement.meetup_location %}
        <h3>Meetup Details</h3>
        <p><strong>Location:</strong> {{ arrangement.meetup_location }}</p>
        <p><strong>Date:</strong> {{ arrangement.meetup_date if arrangement.meetup_date else 'Not set' }}</p>
        <p><strong>Time:</strong> {{ arrangement.meetup_time if arrangement.meetup_time else 'Not set' }}</p>
        {% endif %}
        {% if arrangement and arrangement.delivery_address %}
        <h3>Delivery Details</h3>
        <p><strong>Address:</strong> {{ arrangement.delivery_address }}</p>
        <p><strong>Date:</strong> {{ arrangement.delivery_date if arrangement.delivery_date else 'Not set' }}</p>
        <p><strong>Courier:</strong> {{ arrangement.courier_option if arrangement.courier_option else 'Not set' }}</p>
        {% endif %}
        <p><em>Printed on: ${new Date().toLocaleString()}</em></p>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Trade Arrangement - {{ trade.trade_id }}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h2 { color: #0d47a1; }
                    h3 { color: #1976d2; margin-top: 20px; }
                    p { margin: 8px 0; }
                </style>
            </head>
            <body>${printContent}</body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Enhanced suggestion system
function suggestDate() {
    const today = new Date();
    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    const formattedDate = nextWeek.toISOString().split('T')[0];

    const suggestedDate = prompt('Suggest a date (YYYY-MM-DD):', formattedDate);
    if (suggestedDate) {
        const message = `I suggest we schedule for ${suggestedDate}. Does this work for you?`;
        sendSuggestionMessage(message);
    }
}

// Send message function
function sendMessage() {
    const messageInput = document.getElementById('chatMessage');
    const message = messageInput.value.trim();

    if (!message) {
        showNotification('Please enter a message.', 'warning');
        return;
    }

    // Show sending indicator
    const sendBtn = document.querySelector('.chat-input button');
    const originalText = sendBtn.textContent;
    sendBtn.textContent = 'Sending...';
    sendBtn.disabled = true;

    fetch(`/trade/{{ trade.trade_id }}/send_message`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        sendBtn.textContent = originalText;
        sendBtn.disabled = false;

        if (data.status === 'success') {
            messageInput.value = '';
            location.reload();
        } else {
            showNotification('Failed to send message. Please try again.', 'error');
        }
    })
    .catch(error => {
        sendBtn.textContent = originalText;
        sendBtn.disabled = false;
        showNotification('Network error. Please check your connection.', 'error');
    });
}

function sendSuggestionMessage(message) {
    fetch(`/trade/{{ trade.trade_id }}/send_message`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            showNotification('Suggestion sent successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('Failed to send suggestion.', 'error');
        }
    })
    .catch(error => {
        showNotification('Network error. Please try again.', 'error');
    });
}

// Notification system
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.custom-notification');
    existingNotifications.forEach(notif => notif.remove());

    const notification = document.createElement('div');
    notification.className = `custom-notification`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
    `;

    // Set colors based on type
    const colors = {
        success: 'linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%)',
        error: 'linear-gradient(135deg, #f44336 0%, #ef5350 100%)',
        warning: 'linear-gradient(135deg, #ff9800 0%, #ffb74d 100%)',
        info: 'linear-gradient(135deg, #0d47a1 0%, #1976d2 100%)'
    };

    notification.style.background = colors[type] || colors.info;
    notification.textContent = message;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    .method-option:hover {
        border-color: #0d47a1 !important;
        background: #f0f8ff !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(13, 71, 161, 0.2);
        transition: all 0.3s ease;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }

    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: #0d47a1;
        border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: #1976d2;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .overlay > div:first-child {
            grid-template-columns: 1fr !important;
            gap: 15px !important;
        }

        .method-options {
            grid-template-columns: 1fr !important;
        }

        .status-grid {
            grid-template-columns: 1fr 1fr !important;
        }
    }

    /* Enhanced form styling */
    input:focus, textarea:focus, select:focus {
        border-color: #0d47a1 !important;
        box-shadow: 0 0 0 2px rgba(13, 71, 161, 0.2) !important;
        outline: none;
    }

    /* Chat message animations */
    .message {
        animation: messageSlideIn 0.3s ease;
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
`;
document.head.appendChild(style);

// Form auto-save setup
document.addEventListener('DOMContentLoaded', function() {
    // Initialize method selection
    {% if arrangement and arrangement.method %}
    selectMethod('{{ arrangement.method }}');
    {% endif %}

    // Add form validation on submit
    const arrangementForm = document.getElementById('arrangementForm');
    if (arrangementForm) {
        arrangementForm.addEventListener('submit', function(e) {
            const method = document.getElementById('method').value;
            if (!method) {
                e.preventDefault();
                showNotification('Please select an exchange method.', 'warning');
                return false;
            }
        });
    }

    // Focus on chat input when page loads if there are messages
    {% if messages %}
    setTimeout(() => {
        const chatInput = document.getElementById('chatMessage');
        if (chatInput) chatInput.focus();
    }, 500);
    {% endif %}
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter to send message
    if (e.ctrlKey && e.key === 'Enter') {
        const chatInput = document.getElementById('chatMessage');
        if (document.activeElement === chatInput && chatInput.value.trim()) {
            sendMessage();
        }
    }

    // Escape to clear chat input
    if (e.key === 'Escape') {
        const chatInput = document.getElementById('chatMessage');
        if (document.activeElement === chatInput) {
            chatInput.value = '';
            chatInput.blur();
        }
    }
});
</script>

<style>
.user-status-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #0d47a1;
    margin-bottom: 10px;
}

.user-status-card.confirmed {
    border-left-color: #4CAF50;
    background: #e8f5e8;
}

.confirmation-status {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
}

.confirmation-badge {
    padding: 8px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 12px;
}

.confirmed-badge {
    background: #4CAF50;
    color: white;
}

.pending-badge {
    background: #ff9800;
    color: white;
}

/* Print styles */
@media print {
    .no-print {
        display: none !important;
    }

    .overlay {
        background: white !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}