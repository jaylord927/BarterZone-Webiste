{% extends "base.html" %}

{% block content %}
<section class="hero-section">
  <div class="overlay" style="background: rgba(255,255,255,0.95); color:#333; max-width: 1200px; width:100%; padding:20px; border-radius:10px;">

    <!-- Header -->
    <div style="text-align: center; margin-bottom: 30px;">
      <h2 style="color:#0d47a1; margin-bottom:10px;">Trade Arrangement Details</h2>
      <p style="color:#666; margin:0;">Trade ID: {{ trade.trade_id }} • Trading with:
        {% if trade.offer_user_id == user_id %}
          {{ trade.target_full_name or trade.target_username }}
        {% else %}
          {{ trade.offer_full_name or trade.offer_username }}
        {% endif %}
      </p>
    </div>

    <!-- Progress Guide - FIXED VERSION -->
<div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 10px; margin-bottom: 25px;">
    <h4 style="color:#0d47a1; margin-top:0; text-align: center;">Trade Arrangement Progress</h4>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
        <!-- Step 1: Setup Details -->
        <div style="background: {% if arrangement and arrangement.status %}white{% else %}#e8f5e8{% endif %}; padding: 15px; border-radius: 8px; border: 2px solid {% if arrangement and arrangement.status %}#0d47a1{% else %}#4CAF50{% endif %};">
            <div style="width: 40px; height: 40px; background: {% if arrangement and arrangement.status %}#0d47a1{% else %}#4CAF50{% endif %}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">
                ✓
            </div>
            <h5 style="color:#0d47a1; margin:0 0 8px 0;">Setup Details</h5>
            <p style="margin:0; font-size:13px; color:#666;">Choose method and arrange exchange details</p>
        </div>

        <!-- Step 2: Confirm Exchange -->
        <div style="background: {% if arrangement and arrangement.status %}white{% else %}#e8f5e8{% endif %}; padding: 15px; border-radius: 8px; border: 2px solid {% if arrangement and arrangement.status %}#0d47a1{% else %}#4CAF50{% endif %};">
            <div style="width: 40px; height: 40px; background: {% if arrangement and arrangement.status %}#0d47a1{% else %}#4CAF50{% endif %}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">
                ✓
            </div>
            <h5 style="color:#0d47a1; margin:0 0 8px 0;">Confirm Exchange</h5>
            <p style="margin:0; font-size:13px; color:#666;">Both users confirm arrangement details</p>
        </div>

        <!-- Step 3: Complete Trade -->
        <div style="background: {% if arrangement and arrangement.status == 'completed' %}white{% else %}#f5f5f5{% endif %}; padding: 15px; border-radius: 8px; border: 2px solid {% if arrangement and arrangement.status == 'completed' %}#0d47a1{% else %}#ddd{% endif %};">
            <div style="width: 40px; height: 40px; background: {% if arrangement and arrangement.status == 'completed' %}#0d47a1{% else %}#ddd{% endif %}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold;">
                {% if arrangement and arrangement.status == 'completed' %}✓{% else %}3{% endif %}
            </div>
            <h5 style="color:#0d47a1; margin:0 0 8px 0;">Complete Trade</h5>
            <p style="margin:0; font-size:13px; color:#666;">
                {% if arrangement and arrangement.status == 'completed' %}
                    ✅ Trade Completed!
                {% else %}
                    Exchange items and confirm receipt
                {% endif %}
            </p>
        </div>
    </div>
</div>

    <!-- Current Arrangement Details Display -->
{% if arrangement and arrangement.method %}
<div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 25px;">

    {% if arrangement.status == 'completed' %}
    <!-- COMPLETED TRADE VERSION -->
    <div style="text-align: center; margin-bottom: 25px;">
        <div style="font-size: 64px; margin-bottom: 15px;">🎉</div>
        <h3 style="color:#2e7d32; margin:0 0 10px 0;">Trade Successfully Completed!</h3>
        <p style="color:#4CAF50; font-size: 16px; margin:0;">Both items have been exchanged and received</p>
    </div>
    {% endif %}

    <h4 style="color:#0d47a1; margin-top:0; margin-bottom:20px; display: flex; align-items: center; gap: 8px;">
        <span>📋</span>
        {% if arrangement.status == 'completed' %}
            Trade Completion Summary
        {% else %}
            Exchange Arrangement Details
        {% endif %}
    </h4>

    <!-- Exchange Method Summary -->
    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h5 style="color:#0d47a1; margin:0 0 10px 0; display: flex; align-items: center; gap: 8px;">
            <span>🔄</span> Exchange Method:
            <span style="text-transform: capitalize; background: white; padding: 4px 12px; border-radius: 15px; margin-left: 10px;">
                {{ arrangement.method }}
            </span>
            {% if arrangement.status == 'completed' %}
            <span style="margin-left: auto; background: #4CAF50; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px;">
                ✅ COMPLETED
            </span>
            {% endif %}
        </h5>
    </div>

    <!-- Exchange Details Grid -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">

        <!-- Delivery Exchange Details -->
        {% if arrangement.method in ['delivery', 'mixed'] %}
        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; border-left: 4px solid #4caf50;">
            <h5 style="color:#2e7d32; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                <span>🚚</span> Delivery Exchange
            </h5>

            <div style="display: grid; gap: 12px;">
                <div>
                    <strong style="color:#0d47a1;">🏠 Delivery Address:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                        {{ arrangement.delivery_address or 'Not specified' }}
                    </p>
                </div>

                {% if arrangement.delivery_date %}
                <div>
                    <strong style="color:#0d47a1;">📦 Delivery Date:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                        {{ arrangement.delivery_date }}
                    </p>
                </div>
                {% endif %}

                {% if arrangement.courier_option %}
                <div>
                    <strong style="color:#0d47a1;">🚛 Courier Service:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                        {{ arrangement.courier_option|upper }}
                    </p>
                </div>
                {% endif %}

                {% if arrangement.delivery_instructions %}
                <div>
                    <strong style="color:#0d47a1;">📝 Special Instructions:</strong>
                    <p style="margin: 5px 0 0 0; color:#333; background: white; padding: 8px; border-radius: 6px;">
                        {{ arrangement.delivery_instructions }}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Trade Completion Info -->
        <div style="background: #fff3e0; padding: 20px; border-radius: 10px; border-left: 4px solid #ff9800;">
            <h5 style="color:#ef6c00; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                <span>✅</span> Trade Completion
            </h5>

            <div style="display: grid; gap: 12px;">
                <div>
                    <strong style="color:#0d47a1;">🔄 Items Exchanged:</strong>
                    <div style="margin: 5px 0 0 0; color:#333; background: white; padding: 10px; border-radius: 6px;">
                        <strong>{{ trade.offer_full_name or trade.offer_username }}</strong> received:<br>
                        <span style="color: #4CAF50;">{{ trade.target_item_name }}</span>
                    </div>
                    <div style="margin: 8px 0 0 0; color:#333; background: white; padding: 10px; border-radius: 6px;">
                        <strong>{{ trade.target_full_name or trade.target_username }}</strong> received:<br>
                        <span style="color: #4CAF50;">{{ trade.offer_item_name }}</span>
                    </div>
                </div>

                <div>
                    <strong style="color:#0d47a1;">📊 Completion Details:</strong>
                    <div style="margin: 5px 0 0 0; color:#333; background: white; padding: 10px; border-radius: 6px;">
                        <strong>Status:</strong> <span style="color: #4CAF50; font-weight: bold;">COMPLETED</span><br>
                        <strong>Completed on:</strong> {{ arrangement.updated_at[:16] if arrangement.updated_at else 'Today' }}<br>
                        {% if arrangement.tracking_number %}
                        <strong>Tracking #:</strong> {{ arrangement.tracking_number }}<br>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Status Section -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- User 1 Status -->
        <div class="user-status-card confirmed">
            <h5 style="color:#0d47a1; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                <span>👤</span> {{ trade.offer_full_name or trade.offer_username }}'s Status
            </h5>

            <div class="confirmation-status">
                <span class="confirmation-badge confirmed-badge">
                    ✅ Confirmed
                </span>
                <strong>Details Confirmed</strong>
            </div>

            <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <small style="color:#666; display: block; margin-bottom: 5px;"><strong>Exchange Action:</strong></small>
                <small style="color:#333;">📦 <strong>Delivered to:</strong> {{ arrangement.delivery_address or 'Address not set' }}</small>
            </div>

            <div class="confirmation-status">
                <span class="confirmation-badge confirmed-badge">
                    ✅ Received
                </span>
                <strong>Item Received</strong>
            </div>
        </div>

        <!-- User 2 Status -->
        <div class="user-status-card confirmed">
            <h5 style="color:#0d47a1; margin:0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                <span>👤</span> {{ trade.target_full_name or trade.target_username }}'s Status
            </h5>

            <div class="confirmation-status">
                <span class="confirmation-badge confirmed-badge">
                    ✅ Confirmed
                </span>
                <strong>Details Confirmed</strong>
            </div>

            <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <small style="color:#666; display: block; margin-bottom: 5px;"><strong>Exchange Action:</strong></small>
                <small style="color:#333;">📦 <strong>Delivered to:</strong> {{ arrangement.delivery_address or 'Address not set' }}</small>
            </div>

            <div class="confirmation-status">
                <span class="confirmation-badge confirmed-badge">
                    ✅ Received
                </span>
                <strong>Item Received</strong>
            </div>
        </div>
    </div>

    <!-- Completion Celebration -->
    {% if arrangement.status == 'completed' %}
    <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border-radius: 12px; border: 2px solid #4CAF50; text-align: center;">
        <h4 style="color:#2e7d32; margin:0 0 10px 0;">🎊 Trade Successfully Completed! 🎊</h4>
        <p style="color:#2e7d32; margin:0; font-size: 14px;">
            Thank you for using BarterZone! Both traders have successfully exchanged their items.
        </p>

        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
            <a href="{{ url_for('trade_history') }}"
               style="padding: 10px 20px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; text-decoration: none;">
                📊 View Trade History
            </a>
            <a href="{{ url_for('other_traders_items') }}"
               style="padding: 10px 20px; background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; text-decoration: none;">
                🔄 Start New Trade
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
      <!-- Left Column: Arrangement Form -->
      <div>
        <!-- Method Selection - Only show if no arrangement or status is pending -->
        {% if not arrangement or arrangement.status == 'pending' %}
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
          <h4 style="color:#0d47a1; margin-top:0; margin-bottom:15px;">Select Exchange Method</h4>
          <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
            <div class="method-option {% if arrangement and arrangement.method == 'meetup' %}active{% endif %}"
                 onclick="selectMethod('meetup')"
                 style="border: 2px solid {% if arrangement and arrangement.method == 'meetup' %}#0d47a1{% else %}#e0e0e0{% endif %}; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: {% if arrangement and arrangement.method == 'meetup' %}#e3f2fd{% else %}white{% endif %};">
              <h5 style="color:#0d47a1; margin:0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                <span>🤝</span> Meetup Exchange
              </h5>
              <p style="margin:0 0 10px 0; color:#666; font-size:14px;">Meet in person to exchange items</p>
              <ul style="margin:0; padding-left: 20px; color:#666; font-size:13px;">
                <li>Agree on location, date, and time</li>
                <li>Both users must be present</li>
                <li>Instant item exchange</li>
              </ul>
            </div>

            <div class="method-option {% if arrangement and arrangement.method == 'delivery' %}active{% endif %}"
                 onclick="selectMethod('delivery')"
                 style="border: 2px solid {% if arrangement and arrangement.method == 'delivery' %}#0d47a1{% else %}#e0e0e0{% endif %}; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: {% if arrangement and arrangement.method == 'delivery' %}#e3f2fd{% else %}white{% endif %};">
              <h5 style="color:#0d47a1; margin:0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                <span>🚚</span> Delivery Exchange
              </h5>
              <p style="margin:0 0 10px 0; color:#666; font-size:14px;">Send items via courier/delivery service</p>
              <ul style="margin:0; padding-left: 20px; color:#666; font-size:13px;">
                <li>Provide delivery address</li>
                <li>Set shipping date</li>
                <li>Track package progress</li>
              </ul>
            </div>

            <div class="method-option {% if arrangement and arrangement.method == 'mixed' %}active{% endif %}"
                 onclick="selectMethod('mixed')"
                 style="border: 2px solid {% if arrangement and arrangement.method == 'mixed' %}#0d47a1{% else %}#e0e0e0{% endif %}; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: {% if arrangement and arrangement.method == 'mixed' %}#e3f2fd{% else %}white{% endif %};">
              <h5 style="color:#0d47a1; margin:0 0 8px 0; display: flex; align-items: center; gap: 8px;">
                <span>🔀</span> Mixed Method
              </h5>
              <p style="margin:0 0 10px 0; color:#666; font-size:14px;">One delivers, one meets up</p>
              <ul style="margin:0; padding-left: 20px; color:#666; font-size:13px;">
                <li>Flexible arrangement</li>
                <li>Different methods for each user</li>
                <li>Customized exchange</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Dynamic Form Sections -->
        <form id="arrangementForm" method="POST" action="{{ url_for('trade_arrangement', trade_id=trade.trade_id) }}" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <input type="hidden" name="method" id="method" value="{{ arrangement.method if arrangement }}">

          <!-- Meetup Section -->
          <div id="meetupSection" class="method-section" style="display: {% if arrangement and arrangement.method in ['meetup', 'mixed'] %}block{% else %}none{% endif %}; margin-bottom: 20px;">
            <h5 style="color:#0d47a1; margin-top:0; margin-bottom:15px; display: flex; align-items: center; gap: 8px;">
              <span>📍</span> Meetup Details
            </h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">Location</label>
                <input type="text" name="meetup_location" placeholder="Enter meetup location"
                       value="{{ arrangement.meetup_location if arrangement }}"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">Time</label>
                <input type="time" name="meetup_time" value="{{ arrangement.meetup_time if arrangement }}"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
              </div>
            </div>
            <div style="margin-top: 12px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">Date</label>
              <input type="date" name="meetup_date" value="{{ arrangement.meetup_date if arrangement }}"
                     style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
            </div>
          </div>

          <!-- Delivery Section -->
          <div id="deliverySection" class="method-section" style="display: {% if arrangement and arrangement.method in ['delivery', 'mixed'] %}block{% else %}none{% endif %}; margin-bottom: 20px;">
            <h5 style="color:#0d47a1; margin-top:0; margin-bottom:15px; display: flex; align-items: center; gap: 8px;">
              <span>📦</span> Delivery Details
            </h5>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">Delivery Address</label>
              <textarea name="delivery_address" placeholder="Enter complete delivery address"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px; min-height: 80px; resize: vertical;">{{ arrangement.delivery_address if arrangement }}</textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">Courier Service</label>
                <select name="courier_option" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
                  <option value="">Select courier</option>
                  <option value="lbc" {% if arrangement and arrangement.courier_option == 'lbc' %}selected{% endif %}>LBC</option>
                  <option value="jnt" {% if arrangement and arrangement.courier_option == 'jnt' %}selected{% endif %}>J&T Express</option>
                  <option value="grab" {% if arrangement and arrangement.courier_option == 'grab' %}selected{% endif %}>Grab Delivery</option>
                  <option value="lalamove" {% if arrangement and arrangement.courier_option == 'lalamove' %}selected{% endif %}>Lalamove</option>
                  <option value="other" {% if arrangement and arrangement.courier_option == 'other' %}selected{% endif %}>Other</option>
                </select>
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">Delivery Date</label>
                <input type="date" name="delivery_date" value="{{ arrangement.delivery_date if arrangement }}"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
              </div>
            </div>
            <div style="margin-top: 12px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500; color:#333;">Special Instructions</label>
              <textarea name="delivery_instructions" placeholder="Any special delivery instructions"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px; min-height: 60px; resize: vertical;">{{ arrangement.delivery_instructions if arrangement }}</textarea>
            </div>
          </div>

          <button type="submit"
                  style="width: 100%; padding: 12px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
            💾 Save Arrangement Details
          </button>
        </form>
        {% endif %}
      </div>

      <!-- Right Column: Status & Actions -->
      <div>
        <!-- Status Card -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
          <h4 style="color:#0d47a1; margin-top:0; margin-bottom:15px; display: flex; align-items: center; gap: 8px;">
            <span>📊</span> Trade Status
          </h4>

          <div style="text-align: center; margin-bottom: 20px;">
            <div style="display: inline-block; padding: 8px 20px; background:
              {% if arrangement and arrangement.status == 'completed' %}#e8f5e8
              {% elif arrangement and arrangement.status == 'accepted' %}#e3f2fd
              {% elif arrangement and arrangement.status == 'pending' %}#fff3e0
              {% else %}#f5f5f5{% endif %};
              color: {% if arrangement and arrangement.status == 'completed' %}#2e7d32
              {% elif arrangement and arrangement.status == 'accepted' %}#0d47a1
              {% elif arrangement and arrangement.status == 'pending' %}#ef6c00
              {% else %}#666{% endif %};
              border-radius: 20px; font-weight: bold; border: 2px solid currentColor;">
              {{ arrangement.status|title if arrangement else 'Not Started' }}
            </div>
          </div>

          <!-- User Status Grid -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
            <!-- User 1 -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
              <div style="font-size: 12px; color:#666; margin-bottom: 5px;">{{ trade.offer_full_name or trade.offer_username }}</div>
              <div style="font-size: 20px; margin-bottom: 5px;">{{ '✅' if arrangement and arrangement.user1_confirmed_details else '❌' }}</div>
              <small style="color:#666;">Details Confirmed</small>
              <div style="font-size: 20px; margin-top: 5px;">{{ '✅' if arrangement and arrangement.user1_confirmed_receipt else '❌' }}</div>
              <small style="color:#666;">Item Received</small>
            </div>

            <!-- User 2 -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
              <div style="font-size: 12px; color:#666; margin-bottom: 5px;">{{ trade.target_full_name or trade.target_username }}</div>
              <div style="font-size: 20px; margin-bottom: 5px;">{{ '✅' if arrangement and arrangement.user2_confirmed_details else '❌' }}</div>
              <small style="color:#666;">Details Confirmed</small>
              <div style="font-size: 20px; margin-top: 5px;">{{ '✅' if arrangement and arrangement.user2_confirmed_receipt else '❌' }}</div>
              <small style="color:#666;">Item Received</small>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
          <h4 style="color:#0d47a1; margin-top:0; margin-bottom:15px; display: flex; align-items: center; gap: 8px;">
            <span>⚡</span> Quick Actions
          </h4>

          <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
            {% if arrangement and arrangement.status == 'pending' %}
              {% if not (arrangement.user1_confirmed_details and arrangement.user2_confirmed_details) %}
                {% if (trade.offer_user_id == user_id and not arrangement.user1_confirmed_details) or (trade.target_user_id == user_id and not arrangement.user2_confirmed_details) %}
                <button onclick="confirmDetails()"
                        style="padding: 12px; background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                  ✅ Confirm All Details
                </button>
                {% endif %}
              {% endif %}
            {% endif %}

            {% if arrangement and arrangement.status == 'accepted' %}
              {% if (trade.offer_user_id == user_id and not arrangement.user1_confirmed_receipt) or (trade.target_user_id == user_id and not arrangement.user2_confirmed_receipt) %}
              <button onclick="markReceived()"
                      style="padding: 12px; background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                📦 Mark Item as Received
              </button>
              {% endif %}
            {% endif %}

            <button onclick="openLocationPicker()"
                    style="padding: 12px; background: linear-gradient(135deg, #546e7a 0%, #78909c 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">
              📍 Use My Location
            </button>

            <button onclick="printArrangement()"
                    style="padding: 12px; background: linear-gradient(135deg, #795548 0%, #8d6e63 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">
              🖨️ Print Details
            </button>

            <button onclick="cancelTrade()"
                    style="padding: 12px; background: linear-gradient(135deg, #f44336 0%, #ef5350 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
              ❌ Cancel Trade
            </button>
          </div>
        </div>

        <!-- Negotiation Chat -->
        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <h4 style="color:#0d47a1; margin-top:0; margin-bottom:15px; display: flex; align-items: center; gap: 8px;">
            <span>💬</span> Negotiation & Suggestions
          </h4>

          <div class="chat-messages" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
            {% for message in messages %}
              <div class="message {% if message.user_id == user_id %}own-message{% endif %}"
                   style="background: {% if message.user_id == user_id %}#e3f2fd{% else %}white{% endif %}; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid {% if message.user_id == user_id %}#0d47a1{% else %}#4CAF50{% endif %};">
                <div style="font-weight: bold; color:#0d47a1; margin-bottom: 5px;">{{ message.username }}</div>
                <div style="color:#333; margin-bottom: 5px;">{{ message.content }}</div>
                {% if message.suggested_location %}
                  <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin: 5px 0; font-size: 13px;">
                    📍 Location Suggestion: {{ message.suggested_location }}
                    <button onclick="useSuggestion('{{ message.suggested_location }}')"
                            style="margin-left: 10px; padding: 2px 8px; background: #0d47a1; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                      Use This
                    </button>
                  </div>
                {% endif %}
                <div style="font-size: 11px; color:#666;">{{ message.created_at }}</div>
              </div>
            {% endfor %}
          </div>

          <div class="chat-input" style="display: flex; gap: 8px;">
            <input type="text" id="chatMessage" placeholder="Send a message or suggestion..."
                   style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size:14px;">
            <button onclick="sendMessage()"
                    style="padding: 10px 15px; background: #0d47a1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size:14px;">
              Send
            </button>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 10px;">
            <button onclick="suggestLocation()"
                    style="flex: 1; padding: 8px 12px; background: #546e7a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size:13px;">
              📍 Suggest Location
            </button>
            <button onclick="suggestDate()"
                    style="flex: 1; padding: 8px 12px; background: #546e7a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size:13px;">
              📅 Suggest Date
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
// Enhanced confirmation with validation
function confirmDetails() {
    if (confirm('Are you sure you want to confirm these arrangement details? Once both users confirm, the trade will be accepted.')) {
        // Show loading state
        showNotification('Confirming details...', 'info');

        // Use fetchWithCSRF if available, otherwise use regular fetch
        const fetchFunction = typeof fetchWithCSRF === 'function' ? fetchWithCSRF : fetch;

        fetchFunction(`/trade/{{ trade.trade_id }}/confirm_details`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': typeof getCSRFToken === 'function' ? getCSRFToken() : ''
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showNotification(data.message, 'success');

                // Reload the page after a short delay to show updated status
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification(data.message || 'Failed to confirm details.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error confirming details. Please try again.', 'error');
        });
    }
}

// Enhanced mark received with tracking
function markReceived() {
    const trackingNumber = prompt('Optional: Enter tracking number if available:\n\n📦 Leave blank if not applicable.', '');

    if (trackingNumber === null) {
        console.log('User cancelled the operation');
        return; // User clicked cancel
    }

    if (confirm('Have you received the item from the other trader?')) {
        console.log('User confirmed receipt');

        // Show loading state
        showNotification('Marking item as received...', 'info');

        const data = {};
        if (trackingNumber && trackingNumber.trim() !== '') {
            data.tracking_number = trackingNumber.trim();
            console.log('Tracking number provided:', data.tracking_number);
        } else {
            console.log('No tracking number provided');
        }

        // Simple fetch without CSRF for now to test
        fetch(`/trade/{{ trade.trade_id }}/confirm_receipt`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.status === 'completed') {
                showNotification(data.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } else if (data.status === 'waiting') {
                showNotification(data.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification(data.message || 'Failed to mark item as received.', 'error');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showNotification('Network error. Please check console for details.', 'error');
        });
    } else {
        console.log('User cancelled receipt confirmation');
    }
}

function suggestModification() {
    const currentAddress = '{{ arrangement.delivery_address if arrangement }}';
    const currentDate = '{{ arrangement.delivery_date if arrangement }}';
    const currentCourier = '{{ arrangement.courier_option if arrangement }}';

    const newAddress = prompt('Enter your preferred delivery address:', currentAddress);
    if (newAddress === null) return;

    const newDate = prompt('Enter your preferred delivery date (YYYY-MM-DD):', currentDate);
    const newCourier = prompt('Enter your preferred courier:', currentCourier);

    if (newAddress || newDate || newCourier) {
        let message = "I'd like to suggest some changes to the delivery arrangement:\n";
        if (newAddress && newAddress !== currentAddress) message += `🏠 Address: ${newAddress}\n`;
        if (newDate && newDate !== currentDate) message += `📅 Date: ${newDate}\n`;
        if (newCourier && newCourier !== currentCourier) message += `🚚 Courier: ${newCourier}`;

        if (message.includes(':')) {
            sendSuggestionMessage(message);
        } else {
            alert('No changes were suggested.');
        }
    }
}

function suggestDeliveryModification() {
    const currentAddress = '{{ arrangement.delivery_address if arrangement }}';
    const currentDate = '{{ arrangement.delivery_date if arrangement }}';
    const currentCourier = '{{ arrangement.courier_option if arrangement }}';

    const newAddress = prompt('Enter your preferred delivery address:', currentAddress);
    if (newAddress === null) return;

    const newDate = prompt('Enter your preferred delivery date (YYYY-MM-DD):', currentDate);
    const newCourier = prompt('Enter your preferred courier:', currentCourier);

    if (newAddress || newDate || newCourier) {
        let message = "I'd like to suggest some changes to the delivery arrangement:\n";
        if (newAddress && newAddress !== currentAddress) message += `🏠 Address: ${newAddress}\n`;
        if (newDate && newDate !== currentDate) message += `📅 Date: ${newDate}\n`;
        if (newCourier && newCourier !== currentCourier) message += `🚚 Courier: ${newCourier}`;

        if (message.includes(':')) {
            sendSuggestionMessage(message);
        } else {
            alert('No changes were suggested.');
        }
    }
}

// Enhanced messaging system
function sendMessage() {
    const messageInput = document.getElementById('chatMessage');
    const message = messageInput.value.trim();

    if (!message) {
        showNotification('Please enter a message.', 'warning');
        return;
    }

    // Show sending indicator
    const sendBtn = document.querySelector('.chat-input button');
    const originalText = sendBtn.textContent;
    sendBtn.textContent = 'Sending...';
    sendBtn.disabled = true;

    fetch(`/trade/{{ trade.trade_id }}/send_message`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        sendBtn.textContent = originalText;
        sendBtn.disabled = false;

        if (data.status === 'success') {
            messageInput.value = '';
            location.reload();
        } else {
            showNotification('Failed to send message. Please try again.', 'error');
        }
    })
    .catch(error => {
        sendBtn.textContent = originalText;
        sendBtn.disabled = false;
        showNotification('Network error. Please check your connection.', 'error');
    });
}

function sendSuggestionMessage(message) {
    fetch(`/trade/{{ trade.trade_id }}/send_message`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            showNotification('Suggestion sent successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('Failed to send suggestion.', 'error');
        }
    })
    .catch(error => {
        showNotification('Network error. Please try again.', 'error');
    });
}

// Enhanced suggestion handling
function suggestLocation() {
    const location = prompt('Enter your suggested location:');
    if (location && location.trim()) {
        fetch(`/trade/{{ trade.trade_id }}/suggest_location`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({location: location.trim()})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showNotification('Location suggestion sent!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('Failed to send location suggestion.', 'error');
            }
        })
        .catch(error => {
            showNotification('Network error. Please try again.', 'error');
        });
    }
}

function useSuggestion(location) {
    if (confirm(`Use this suggested location: "${location}"?`)) {
        document.querySelector('input[name="meetup_location"]').value = location;
        document.getElementById('method').value = 'meetup';
        selectMethod('meetup');
        showNotification('Location applied to meetup details!', 'success');
    }
}

// Enhanced trade cancellation
function cancelTrade() {
    const reason = prompt('Please provide a reason for cancellation (optional):');
    const confirmation = confirm('Are you sure you want to cancel this trade? This action cannot be undone.');

    if (confirmation) {
        fetch(`/trade/{{ trade.trade_id }}/cancel`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({reason: reason})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                showNotification('Trade cancelled successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '/trade_history';
                }, 2000);
            } else {
                showNotification('Failed to cancel trade. Please try again.', 'error');
            }
        })
        .catch(error => {
            showNotification('Network error. Please try again.', 'error');
        });
    }
}

// Enhanced method selection with auto-save
function selectMethod(method) {
    document.getElementById('method').value = method;

    // Update method option styles
    document.querySelectorAll('.method-option').forEach(option => {
        option.style.borderColor = '#e0e0e0';
        option.style.background = 'white';
    });

    const selectedOption = document.querySelector(`.method-option[onclick="selectMethod('${method}')"]`);
    if (selectedOption) {
        selectedOption.style.borderColor = '#0d47a1';
        selectedOption.style.background = '#e3f2fd';
    }

    // Show/hide sections
    document.querySelectorAll('.method-section').forEach(section => {
        section.style.display = 'none';
    });

    if (method === 'meetup') {
        document.getElementById('meetupSection').style.display = 'block';
    } else if (method === 'delivery') {
        document.getElementById('deliverySection').style.display = 'block';
    } else if (method === 'mixed') {
        document.getElementById('meetupSection').style.display = 'block';
        document.getElementById('deliverySection').style.display = 'block';
    }
}

// Location picker integration
function openLocationPicker() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const location = `${lat}, ${lng}`;

                if (confirm(`Use your current location? ${location}`)) {
                    document.querySelector('input[name="meetup_location"]').value = `GPS: ${location}`;
                    document.getElementById('method').value = 'meetup';
                    selectMethod('meetup');
                }
            },
            (error) => {
                alert('Unable to get your location. Please enter it manually.');
            }
        );
    } else {
        alert('Geolocation is not supported by your browser.');
    }
}

// Print arrangement details
function printArrangement() {
    const printContent = `
        <h2>Trade Arrangement Details</h2>
        <p><strong>Trade ID:</strong> {{ trade.trade_id }}</p>
        <p><strong>Parties:</strong> {{ trade.offer_full_name or trade.offer_username }} ↔ {{ trade.target_full_name or trade.target_username }}</p>
        <p><strong>Status:</strong> {{ arrangement.status if arrangement else 'Not Started' }}</p>
        <p><strong>Method:</strong> {{ arrangement.method if arrangement else 'Not Set' }}</p>
        {% if arrangement and arrangement.meetup_location %}
        <h3>Meetup Details</h3>
        <p><strong>Location:</strong> {{ arrangement.meetup_location }}</p>
        <p><strong>Date:</strong> {{ arrangement.meetup_date if arrangement.meetup_date else 'Not set' }}</p>
        <p><strong>Time:</strong> {{ arrangement.meetup_time if arrangement.meetup_time else 'Not set' }}</p>
        {% endif %}
        {% if arrangement and arrangement.delivery_address %}
        <h3>Delivery Details</h3>
        <p><strong>Address:</strong> {{ arrangement.delivery_address }}</p>
        <p><strong>Date:</strong> {{ arrangement.delivery_date if arrangement.delivery_date else 'Not set' }}</p>
        <p><strong>Courier:</strong> {{ arrangement.courier_option if arrangement.courier_option else 'Not set' }}</p>
        {% endif %}
        <p><em>Printed on: ${new Date().toLocaleString()}</em></p>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Trade Arrangement - {{ trade.trade_id }}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h2 { color: #0d47a1; }
                    h3 { color: #1976d2; margin-top: 20px; }
                    p { margin: 8px 0; }
                </style>
            </head>
            <body>${printContent}</body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Enhanced suggestion system
function suggestDate() {
    const today = new Date();
    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
    const formattedDate = nextWeek.toISOString().split('T')[0];

    const suggestedDate = prompt('Suggest a date (YYYY-MM-DD):', formattedDate);
    if (suggestedDate) {
        const message = `I suggest we schedule for ${suggestedDate}. Does this work for you?`;
        sendSuggestionMessage(message);
    }
}

// Notification system
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.custom-notification');
    existingNotifications.forEach(notif => notif.remove());

    const notification = document.createElement('div');
    notification.className = `custom-notification`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        animation: slideIn 0.3s ease;
    `;

    // Set colors based on type
    const colors = {
        success: 'linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%)',
        error: 'linear-gradient(135deg, #f44336 0%, #ef5350 100%)',
        warning: 'linear-gradient(135deg, #ff9800 0%, #ffb74d 100%)',
        info: 'linear-gradient(135deg, #0d47a1 0%, #1976d2 100%)'
    };

    notification.style.background = colors[type] || colors.info;
    notification.textContent = message;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Form auto-save setup
document.addEventListener('DOMContentLoaded', function() {
    // Initialize method selection
    {% if arrangement and arrangement.method %}
    selectMethod('{{ arrangement.method }}');
    {% endif %}

    // Add form validation on submit
    document.getElementById('arrangementForm').addEventListener('submit', function(e) {
        if (!validateForm() || !validateDates()) {
            e.preventDefault();
            return false;
        }
    });

    // Focus on chat input when page loads if there are messages
    {% if messages %}
    setTimeout(() => {
        document.getElementById('chatMessage').focus();
    }, 500);
    {% endif %}
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter to send message
    if (e.ctrlKey && e.key === 'Enter') {
        const chatInput = document.getElementById('chatMessage');
        if (document.activeElement === chatInput && chatInput.value.trim()) {
            sendMessage();
        }
    }

    // Escape to clear chat input
    if (e.key === 'Escape') {
        const chatInput = document.getElementById('chatMessage');
        if (document.activeElement === chatInput) {
            chatInput.value = '';
            chatInput.blur();
        }
    }
});
</script>

<style>
.method-option:hover {
    border-color: #0d47a1 !important;
    background: #f0f8ff !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(13, 71, 161, 0.2);
    transition: all 0.3s ease;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #0d47a1;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #1976d2;
}

/* Responsive design */
@media (max-width: 768px) {
    .overlay {
        padding: 15px !important;
    }

    .hero-section .overlay > div {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
    }

    .method-options {
        grid-template-columns: 1fr !important;
    }

    .status-grid {
        grid-template-columns: 1fr 1fr !important;
    }
}

/* Enhanced form styling */
input:focus, textarea:focus, select:focus {
    border-color: #0d47a1 !important;
    box-shadow: 0 0 0 2px rgba(13, 71, 161, 0.2) !important;
    outline: none;
}

/* Chat message animations */
.message {
    animation: messageSlideIn 0.3s ease;
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Print styles */
@media print {
    .no-print {
        display: none !important;
    }

    .overlay {
        background: white !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}