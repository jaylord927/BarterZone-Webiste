{% extends "base.html" %}
{% block content %}
<section class="hero-section">
  <div class="overlay" style="background: rgba(255,255,255,0.95); color:#333; max-width: 1200px; width:100%; padding:20px; border-radius:10px;">

    <h2 style="color:#0d47a1; margin-bottom:20px; text-align: center;">Trade History & Arrangements</h2>

    <!-- User Guidance Section -->
    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 5px solid #0d47a1;">
      <h4 style="color:#0d47a1; margin-top:0;">📋 BarterZone Trade Guide</h4>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div style="background: white; padding: 15px; border-radius: 8px;">
          <h5 style="color:#0d47a1; margin:0 0 10px 0;">🤝 Meetup Exchange</h5>
          <p style="margin:0; font-size:14px;">Agree on location, date, and time. Meet in person to exchange items.</p>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px;">
          <h5 style="color:#0d47a1; margin:0 0 10px 0;">🚚 Delivery Exchange</h5>
          <p style="margin:0; font-size:14px;">Send items via courier. Provide addresses and track deliveries.</p>
        </div>
        <div style="background: white; padding: 15px; border-radius: 8px;">
          <h5 style="color:#0d47a1; margin:0 0 10px 0;">🔀 Mixed Method</h5>
          <p style="margin:0; font-size:14px;">One delivers, one meets up. Flexible arrangement options.</p>
        </div>
      </div>
    </div>

    {% if history %}
<div style="overflow-x: auto;">
    <table style="width:100%; border-collapse:collapse; text-align:left; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <thead>
            <tr style="background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color:white;">
                <th style="padding:15px; font-size:14px;">Trade Details</th>
                <th style="padding:15px; font-size:14px;">Exchange Method</th>
                <th style="padding:15px; font-size:14px;">Arrangement Status</th>
                <th style="padding:15px; font-size:14px;">Receipt Status</th>
                <th style="padding:15px; font-size:14px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for trade in history %}
            <tr style="border-bottom:1px solid #f0f0f0; transition: background-color 0.3s ease;">
                <td style="padding:15px;">
    <!-- Trade Partner Info -->
    <div style="margin-bottom: 10px;">
        <strong style="color:#0d47a1;">
            {% if trade['offer_user_id'] == session.user_id %}
                Trading with: {{ trade['target_full_name'] or trade['target_username'] }}
            {% else %}
                Trading with: {{ trade['offer_full_name'] or trade['offer_username'] }}
            {% endif %}
        </strong>
    </div>

    <!-- Item Exchange with Images -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
        <!-- Your Item -->
        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
            <small style="color:#666;">Your Item:</small>

            <!-- Item Image -->
            <div style="height: 60px; margin: 5px 0; border-radius: 4px; overflow: hidden; background: #e0e0e0;">
                {% if trade['offer_user_id'] == session.user_id %}
                    <!-- You are the offer user - show your offered item -->
                    {% if trade['offer_item_image'] %}
                    <img src="{{ trade['offer_item_image'] }}"
                         alt="{{ trade['offer_item_name'] }}"
                         style="width: 100%; height: 100%; object-fit: cover;"
                         onerror="this.src='https://via.placeholder.com/100x60/0d47a1/ffffff?text=No+Image'">
                    {% else %}
                    <img src="https://via.placeholder.com/100x60/0d47a1/ffffff?text=No+Image"
                         alt="{{ trade['offer_item_name'] }}"
                         style="width: 100%; height: 100%; object-fit: cover;">
                    {% endif %}
                {% else %}
                    <!-- You are the target user - show the item you received -->
                    {% if trade['target_item_image'] %}
                    <img src="{{ trade['target_item_image'] }}"
                         alt="{{ trade['target_item_name'] }}"
                         style="width: 100%; height: 100%; object-fit: cover;"
                         onerror="this.src='https://via.placeholder.com/100x60/0d47a1/ffffff?text=No+Image'">
                    {% else %}
                    <img src="https://via.placeholder.com/100x60/0d47a1/ffffff?text=No+Image"
                         alt="{{ trade['target_item_name'] }}"
                         style="width: 100%; height: 100%; object-fit: cover;">
                    {% endif %}
                {% endif %}
            </div>

            <div style="font-weight:500; font-size: 12px; margin-top: 5px;">
                {% if trade['offer_user_id'] == session.user_id %}
                    {{ trade['offer_item_name'] }}
                {% else %}
                    {{ trade['target_item_name'] }}
                {% endif %}
            </div>
        </div>

        <!-- Their Item -->
        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;">
            <small style="color:#666;">Their Item:</small>

            <!-- Item Image -->
            <div style="height: 60px; margin: 5px 0; border-radius: 4px; overflow: hidden; background: #e0e0e0;">
                {% if trade['offer_user_id'] == session.user_id %}
                    <!-- You are the offer user - show the item you receive -->
                    {% if trade['target_item_image'] %}
                    <img src="{{ trade['target_item_image'] }}"
                         alt="{{ trade['target_item_name'] }}"
                         style="width: 100%; height: 100%; object-fit: cover;"
                         onerror="this.src='https://via.placeholder.com/100x60/546e7a/ffffff?text=No+Image'">
                    {% else %}
                    <img src="https://via.placeholder.com/100x60/546e7a/ffffff?text=No+Image"
                         alt="{{ trade['target_item_name'] }}"
                         style="width: 100%; height: 100%; object-fit: cover;">
                    {% endif %}
                {% else %}
                    <!-- You are the target user - show their offered item -->
                    {% if trade['offer_item_image'] %}
                    <img src="{{ trade['offer_item_image'] }}"
                         alt="{{ trade['offer_item_name'] }}"
                         style="width: 100%; height: 100%; object-fit: cover;"
                         onerror="this.src='https://via.placeholder.com/100x60/546e7a/ffffff?text=No+Image'">
                    {% else %}
                    <img src="https://via.placeholder.com/100x60/546e7a/ffffff?text=No+Image"
                         alt="{{ trade['offer_item_name'] }}"
                         style="width: 100%; height: 100%; object-fit: cover;">
                    {% endif %}
                {% endif %}
            </div>

            <div style="font-weight:500; font-size: 12px; margin-top: 5px;">
                {% if trade['offer_user_id'] == session.user_id %}
                    {{ trade['target_item_name'] }}
                {% else %}
                    {{ trade['offer_item_name'] }}
                {% endif %}
            </div>
        </div>
    </div>

    <small style="color: #666;">Trade Date: {{ trade['trade_date'] }}</small>

    <!-- Arrangement Details Preview -->
    {% if trade['arrangement_method'] %}
    <div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px;">
        <small style="color:#0d47a1;">
            <strong>Method:</strong> {{ trade['arrangement_method']|title }}
            {% if trade['arrangement_method'] == 'delivery' and trade['delivery_address'] %}
            • {{ trade['delivery_address'][:20] }}...
            {% elif trade['arrangement_method'] == 'meetup' and trade['meetup_location'] %}
            • {{ trade['meetup_location'][:20] }}...
            {% endif %}
        </small>
    </div>
    {% endif %}
</td>

                <td style="padding:15px;">
                    {% if trade['arrangement_method'] %}
                        <div style="text-align: center;">
                            {% if trade['arrangement_method'] == 'meetup' %}
                                <div style="background: #e8f5e8; color: #2e7d32; padding: 8px; border-radius: 6px; border: 1px solid #2e7d32;">
                                    <strong>🤝 Meetup</strong>
                                </div>
                                {% if trade['meetup_location'] %}
                                <small style="display:block; margin-top:5px; color:#666;">{{ trade['meetup_location'] }}</small>
                                {% endif %}
                            {% elif trade['arrangement_method'] == 'delivery' %}
                                <div style="background: #e3f2fd; color: #0d47a1; padding: 8px; border-radius: 6px; border: 1px solid #0d47a1;">
                                    <strong>🚚 Delivery</strong>
                                </div>
                                {% if trade['delivery_address'] %}
                                <small style="display:block; margin-top:5px; color:#666;">{{ trade['delivery_address'][:25] }}...</small>
                                {% endif %}
                            {% elif trade['arrangement_method'] == 'mixed' %}
                                <div style="background: #fff3e0; color: #ef6c00; padding: 8px; border-radius: 6px; border: 1px solid #ef6c00;">
                                    <strong>🔀 Mixed</strong>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div style="text-align: center;">
                            <div style="background: #fff3e0; color: #ef6c00; padding: 8px; border-radius: 6px; border: 1px solid #ef6c00;">
                                <strong>⏳ Pending Setup</strong>
                            </div>
                        </div>
                    {% endif %}
                </td>

                <!-- In the trade history table, update the status display -->
<td style="padding:15px;">
    {% if trade['arrangement_status'] %}
        <div style="text-align: center;">
            {% if trade['arrangement_status'] == 'pending' %}
                <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background-color: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00;">
                    ⏳ Negotiating
                </span>
            {% elif trade['arrangement_status'] == 'accepted' %}
                <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background-color: #e8f5e8; color: #2e7d32; border: 1px solid #2e7d32;">
                    ✅ Accepted
                </span>
            {% elif trade['arrangement_status'] == 'completed' %}
                <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background-color: #e3f2fd; color: #0d47a1; border: 1px solid #0d47a1;">
                    🎉 Completed
                </span>
                <small style="display:block; margin-top:5px; color:#666;">Exchange successful</small>
            {% else %}
                <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background-color: #ffebee; color: #c62828; border: 1px solid #c62828;">
                    ❌ Cancelled
                </span>
            {% endif %}
        </div>
    {% else %}
        <div style="text-align: center;">
            <span style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background-color: #f5f5f5; color: #666; border: 1px solid #ddd;">
                Not Started
            </span>
        </div>
    {% endif %}
</td>

                <td style="padding:15px;">
                    <div style="text-align: center;">
                        {% if trade['offer_received'] and trade['target_received'] %}
                            <div style="background: #e8f5e8; color: #2e7d32; padding: 8px; border-radius: 6px; border: 1px solid #2e7d32;">
                                <strong>✅ Both Received</strong>
                            </div>
                            <small style="display:block; margin-top:5px; color:#666;">Items exchanged</small>
                        {% elif trade['offer_received'] or trade['target_received'] %}
                            <div style="background: #fff3e0; color: #ef6c00; padding: 8px; border-radius: 6px; border: 1px solid #ef6c00;">
                                <strong>⏳ One Received</strong>
                            </div>
                            <small style="display:block; margin-top:5px; color:#666;">
                                {% if trade['offer_user_id'] == session.user_id and trade['offer_received'] %}
                                    You received
                                {% elif trade['target_user_id'] == session.user_id and trade['target_received'] %}
                                    You received
                                {% else %}
                                    They received
                                {% endif %}
                            </small>
                        {% else %}
                            <div style="background: #f5f5f5; color: #666; padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                                <strong>📦 Not Received</strong>
                            </div>
                        {% endif %}
                    </div>
                </td>

                <!-- In the Actions column of trade_history.html -->
<td style="padding:15px;">
    <div style="display: flex; gap: 5px; flex-direction: column;">
        {% if trade['arrangement_status'] == 'accepted' %}
            <a href="{{ url_for('trade_arrangement', trade_id=trade['trade_id']) }}"
               style="padding: 8px 12px; background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; text-decoration: none; text-align: center;">
                🔄 Manage Exchange
            </a>

            <!-- Mark as Received Button - FIXED -->
            {% if (trade['offer_user_id'] == session.user_id and not trade['offer_received']) or
                  (trade['target_user_id'] == session.user_id and not trade['target_received']) %}
                <form method="POST" action="{{ url_for('mark_item_received', trade_id=trade['trade_id']) }}" style="margin:0;">
                    <button type="submit"
                            style="width:100%; padding: 6px 10px; background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%); color: white; border: none; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer;">
                        📦 Mark as Received
                    </button>
                </form>
            {% endif %}

        {% elif trade['arrangement_status'] == 'completed' %}
            <div style="text-align: center;">
                <span style="color: #4CAF50; font-weight: bold;">✓ Trade Completed</span>
                <br>
                <small style="color: #666;">Items marked as unavailable</small>
            </div>
        {% endif %}

        <!-- View Details Button -->
        <a href="{{ url_for('trade_arrangement', trade_id=trade['trade_id']) }}"
           style="padding: 6px 10px; background: #546e7a; color: white; border: none; border-radius: 4px; font-size: 11px; text-decoration: none; text-align: center;">
            View Details
        </a>
    </div>
</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
    <!-- Empty state -->
    <div style="text-align: center; padding: 60px 20px; color: #666;">
      <div style="font-size: 64px; margin-bottom: 20px;">📦</div>
      <h3 style="color: #999; margin-bottom: 15px;">No Trade History Yet</h3>
      <p style="margin-bottom: 25px; max-width: 500px; margin-left: auto; margin-right: auto;">
        When you complete trade arrangements and exchanges, they will appear here with detailed status tracking.
      </p>
      <div style="display: flex; gap: 15px; justify-content: center;">
        <a href="{{ url_for('other_traders_items') }}"
           style="padding: 12px 24px; background: linear-gradient(135deg, #0d47a1 0%, #1976d2 100%); color: white; border: none; border-radius: 6px; text-decoration: none; font-weight: bold;">
          Browse Items to Trade
        </a>
        <a href="{{ url_for('view_trade_requests') }}"
           style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color: white; border: none; border-radius: 6px; text-decoration: none; font-weight: bold;">
          View Trade Requests
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</section>

<script>
// Function to toggle details view
function toggleDetails(tradeId) {
  const detailsRow = document.getElementById('details-' + tradeId);
  if (detailsRow.style.display === 'none') {
    detailsRow.style.display = 'table-row';
  } else {
    detailsRow.style.display = 'none';
  }
}

// Make entire row clickable for details (except action buttons)
document.addEventListener('DOMContentLoaded', function() {
  const rows = document.querySelectorAll('tbody tr');
  rows.forEach(row => {
    if (!row.id.startsWith('details-')) {
      row.addEventListener('click', function(e) {
        // Don't trigger if clicking on buttons or links
        if (!e.target.closest('a') && !e.target.closest('button') && !e.target.closest('form')) {
          const tradeId = this.querySelector('td:last-child small')?.textContent.match(/Trade ID: (\d+)/)?.[1];
          if (tradeId) {
            toggleDetails(tradeId);
          }
        }
      });
    }
  });
});
</script>

<style>
tbody tr:not([id]):hover {
  background-color: #f8f9fa !important;
  cursor: pointer;
}
</style>
{% endblock %}