{% extends "base.html" %}
{% block content %}
<section class="hero-section">
  <div class="overlay" style="background: rgba(255,255,255,0.95); color:#333; max-width: 1200px; width:100%; padding:20px; border-radius:10px;">
    
    <h2 style="color:#0d47a1; margin-bottom:20px;">Trade History</h2>
    
    {% if history %}
    <div style="overflow-x: auto;">
      <table style="width:100%; border-collapse:collapse; text-align:left;">
        <thead>
          <tr style="background-color:#0d47a1; color:white;">
            <th style="padding:12px;">Offered By</th>
            <th style="padding:12px;">Traded With</th>
            <th style="padding:12px;">Offered Item</th>
            <th style="padding:12px;">Target Item</th>
            <th style="padding:12px;">Status</th>
            <th style="padding:12px;">Date Completed</th>
            <th style="padding:12px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for trade in history %}
          <tr style="border-bottom:1px solid #ddd;">
            <td style="padding:12px; font-weight:bold; color:#0d47a1;">
              {{ trade['offer_full_name'] or trade['offer_username'] }}
            </td>
            <td style="padding:12px; font-weight:bold; color:#0d47a1;">
              {{ trade['target_full_name'] or trade['target_username'] }}
            </td>
            <td style="padding:12px;">
              {% if trade['offer_item_name'] %}
                {{ trade['offer_item_name'] }}
              {% else %}
                <span style="color: #999; font-style: italic;">[Item Deleted]</span>
              {% endif %}
            </td>
            <td style="padding:12px;">
              {% if trade['target_item_name'] %}
                {{ trade['target_item_name'] }}
              {% else %}
                <span style="color: #999; font-style: italic;">[Item Deleted]</span>
              {% endif %}
            </td>
            <td style="padding:12px;">
              {% if trade['trade_status'] == 'completed' %}
                <span style="padding: 4px 8px; border-radius: 4px; background-color: #e8f5e8; color: #2e7d32; font-weight: bold;">
                  Completed
                </span>
              {% else %}
                <span style="padding: 4px 8px; border-radius: 4px; background-color: #fff3e0; color: #ef6c00; font-weight: bold;">
                  Accepted
                </span>
              {% endif %}
            </td>
            <td style="padding:12px;">{{ trade['trade_date'] }}</td>
            <td style="padding:12px;">
              {% if trade['trade_status'] == 'completed' %}
                <span style="padding: 4px 8px; border-radius: 4px; background-color: #4CAF50; color: white; font-size: 12px;">
                  Both Received
                </span>
              {% else %}
                {# Check if current user is offer trader #}
                {% if trade['offer_user_id'] == user_id %}
                  {% if trade['offer_received'] %}
                    {% if trade['target_received'] %}
                      <span style="padding: 4px 8px; border-radius: 4px; background-color: #4CAF50; color: white; font-size: 12px;">
                        Both Received
                      </span>
                    {% else %}
                      <span style="padding: 4px 8px; border-radius: 4px; background-color: #ff9800; color: white; font-size: 12px;">
                        Waiting for {{ trade['target_full_name'] or trade['target_username'] }} to receive
                      </span>
                    {% endif %}
                  {% else %}
                    <form method="POST" action="{{ url_for('mark_item_received', trade_id=trade['trade_id']) }}" style="display: inline;">
                      <button type="submit" class="btn-primary" style="padding: 4px 8px; font-size: 12px; background-color: #ff9800;">
                        Mark Received
                      </button>
                    </form>
                  {% endif %}

                {# Check if current user is target trader #}
                {% else %}
                  {% if trade['target_received'] %}
                    {% if trade['offer_received'] %}
                      <span style="padding: 4px 8px; border-radius: 4px; background-color: #4CAF50; color: white; font-size: 12px;">
                        Both Received
                      </span>
                    {% else %}
                      <span style="padding: 4px 8px; border-radius: 4px; background-color: #ff9800; color: white; font-size: 12px;">
                        Waiting for {{ trade['offer_full_name'] or trade['offer_username'] }} to receive
                      </span>
                    {% endif %}
                  {% else %}
                    <form method="POST" action="{{ url_for('mark_item_received', trade_id=trade['trade_id']) }}" style="display: inline;">
                      <button type="submit" class="btn-primary" style="padding: 4px 8px; font-size: 12px; background-color: #ff9800;">
                        Mark Received
                      </button>
                    </form>
                  {% endif %}
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="margin-top: 20px; padding: 15px; background-color: #e3f2fd; border-radius: 5px;">
      <p style="margin: 0; color: #0d47a1;">
        <strong>Note:</strong>
        <span style="background-color: #fff3e0; padding: 2px 6px; border-radius: 3px; color: #ef6c00;">Accepted</span> = Trade accepted, waiting for items to be received
        <span style="margin-left: 15px; background-color: #e8f5e8; padding: 2px 6px; border-radius: 3px; color: #2e7d32;">Completed</span> = Both traders have received their items
      </p>
    </div>

    {% else %}
    <div style="text-align: center; padding: 40px;">
      <h3 style="color:#666; margin-bottom:15px;">No Trade History</h3>
      <p style="color:#999; margin-bottom:20px;">You haven't completed any trades yet.</p>
    </div>
    {% endif %}

    <div style="margin-top:20px;">
      <a href="{{ url_for('view_trade_requests') }}" class="btn-primary">Back to Trade Requests</a>
      <a href="{{ url_for('dashboard') }}" class="btn-primary" style="background-color: #546e7a; margin-left:10px;">Back to Dashboard</a>
    </div>

  </div>
</section>
{% endblock %}